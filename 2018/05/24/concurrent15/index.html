<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Java并发," />





  <link rel="alternate" href="/atom.xml" title="How 2 Play Life" type="application/atom+xml" />






<meta name="description" content="本文首发于我的个人博客：https://h2pl.github.io/ 欢迎阅览我的CSDN专栏：Java并发指南https://blog.csdn.net/column/details/21961.html 相关代码会放在我的的Github：https://github.com/h2pl/">
<meta name="keywords" content="Java并发">
<meta property="og:type" content="article">
<meta property="og:title" content="Java并发指南15：Fork join并发框架与工作窃取算法剖析">
<meta property="og:url" content="http://h2pl.github.io/2018/05/24/concurrent15/index.html">
<meta property="og:site_name" content="How 2 Play Life">
<meta property="og:description" content="本文首发于我的个人博客：https://h2pl.github.io/ 欢迎阅览我的CSDN专栏：Java并发指南https://blog.csdn.net/column/details/21961.html 相关代码会放在我的的Github：https://github.com/h2pl/">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://infoqstatic.com/resource/articles/fork-join-introduction/zh/resources/21.png">
<meta property="og:image" content="http://ifeve.com/wp-content/uploads/2013/12/fj.png">
<meta property="og:updated_time" content="2018-06-11T13:00:45.832Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Java并发指南15：Fork join并发框架与工作窃取算法剖析">
<meta name="twitter:description" content="本文首发于我的个人博客：https://h2pl.github.io/ 欢迎阅览我的CSDN专栏：Java并发指南https://blog.csdn.net/column/details/21961.html 相关代码会放在我的的Github：https://github.com/h2pl/">
<meta name="twitter:image" content="http://infoqstatic.com/resource/articles/fork-join-introduction/zh/resources/21.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"hide","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://h2pl.github.io/2018/05/24/concurrent15/"/>





  <title>Java并发指南15：Fork join并发框架与工作窃取算法剖析 | How 2 Play Life</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

	<a href="https://github.com/h2pl"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub"></a>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">How 2 Play Life</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Java后端开发之路</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://h2pl.github.io/2018/05/24/concurrent15/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="h2pl">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="How 2 Play Life">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Java并发指南15：Fork join并发框架与工作窃取算法剖析</h1>
        

        <div class="post-meta">
        
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-24T22:47:05+08:00">
                2018-05-24
              </time>
            

            

            
          </span>

          
            <span id="busuanzi_container_page_pv">&nbsp;&nbsp;|&nbsp;&nbsp;阅读量 <span id="busuanzi_value_page_pv"></span> 次</span>
          

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/后端/" itemprop="url" rel="index">
                    <span itemprop="name">后端</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/后端/Java并发/" itemprop="url" rel="index">
                    <span itemprop="name">Java并发</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  4,344
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>本文首发于我的个人博客：<a href="https://h2pl.github.io/">https://h2pl.github.io/</a></p>
<p>欢迎阅览我的CSDN专栏：Java并发指南<br><a href="https://blog.csdn.net/column/details/21961.html" target="_blank" rel="noopener">https://blog.csdn.net/column/details/21961.html</a></p>
<p>相关代码会放在我的的Github：<a href="https://github.com/h2pl/" target="_blank" rel="noopener">https://github.com/h2pl/</a></p>
<a id="more"></a>
<p>转载自_<a href="http://ifeve.com/" target="_blank" rel="noopener">并发编程网 – ifeve.com</a></p>
<h2 id="什么是Fork-Join框架"><a href="#什么是Fork-Join框架" class="headerlink" title="什么是Fork/Join框架"></a>什么是Fork/Join框架</h2><p>Fork/Join框架是Java7提供了的一个用于并行执行任务的框架， 是一个把大任务分割成若干个小任务，最终汇总每个小任务结果后得到大任务结果的框架。</p>
<p>我们再通过Fork和Join这两个单词来理解下Fork/Join框架，Fork就是把一个大任务切分为若干子任务并行的执行，Join就是合并这些子任务的执行结果，最后得到这个大任务的结果。比如计算1+2+。。＋10000，可以分割成10个子任务，每个子任务分别对1000个数进行求和，最终汇总这10个子任务的结果。Fork/Join的运行流程图如下：</p>
<p><img src="http://infoqstatic.com/resource/articles/fork-join-introduction/zh/resources/21.png" alt=""></p>
<h2 id="工作窃取算法"><a href="#工作窃取算法" class="headerlink" title="工作窃取算法"></a>工作窃取算法</h2><p>工作窃取（work-stealing）算法是指某个线程从其他队列里窃取任务来执行。工作窃取的运行流程图如下：</p>
<p><img src="http://ifeve.com/wp-content/uploads/2013/12/fj.png" alt="fj"></p>
<p>那么为什么需要使用工作窃取算法呢？假如我们需要做一个比较大的任务，我们可以把这个任务分割为若干互不依赖的子任务，为了减少线程间的竞争，于是把这些子任务分别放到不同的队列里，并为每个队列创建一个单独的线程来执行队列里的任务，线程和队列一一对应，比如A线程负责处理A队列里的任务。但是有的线程会先把自己队列里的任务干完，而其他线程对应的队列里还有任务等待处理。干完活的线程与其等着，不如去帮其他线程干活，于是它就去其他线程的队列里窃取一个任务来执行。而在这时它们会访问同一个队列，所以为了减少窃取任务线程和被窃取任务线程之间的竞争，通常会使用双端队列，被窃取任务线程永远从双端队列的头部拿任务执行，而窃取任务的线程永远从双端队列的尾部拿任务执行。</p>
<p>工作窃取算法的优点是充分利用线程进行并行计算，并减少了线程间的竞争，其缺点是在某些情况下还是存在竞争，比如双端队列里只有一个任务时。并且消耗了更多的系统资源，比如创建多个线程和多个双端队列。</p>
<h2 id="Fork-Join框架的介绍"><a href="#Fork-Join框架的介绍" class="headerlink" title="Fork/Join框架的介绍"></a>Fork/Join框架的介绍</h2><p>我们已经很清楚Fork/Join框架的需求了，那么我们可以思考一下，如果让我们来设计一个Fork/Join框架，该如何设计？这个思考有助于你理解Fork/Join框架的设计。</p>
<p>第一步分割任务。首先我们需要有一个fork类来把大任务分割成子任务，有可能子任务还是很大，所以还需要不停的分割，直到分割出的子任务足够小。</p>
<p>第二步执行任务并合并结果。分割的子任务分别放在双端队列里，然后几个启动线程分别从双端队列里获取任务执行。子任务执行完的结果都统一放在一个队列里，启动一个线程从队列里拿数据，然后合并这些数据。</p>
<p>Fork/Join使用两个类来完成以上两件事情：</p>
<ul>
<li>ForkJoinTask：我们要使用ForkJoin框架，必须首先创建一个ForkJoin任务。它提供在任务中执行fork()和join()操作的机制，通常情况下我们不需要直接继承ForkJoinTask类，而只需要继承它的子类，Fork/Join框架提供了以下两个子类：<ul>
<li>RecursiveAction：用于没有返回结果的任务。</li>
<li>RecursiveTask ：用于有返回结果的任务。</li>
</ul>
</li>
<li>ForkJoinPool ：ForkJoinTask需要通过ForkJoinPool来执行，任务分割出的子任务会添加到当前工作线程所维护的双端队列中，进入队列的头部。当一个工作线程的队列里暂时没有任务时，它会随机从其他工作线程的队列的尾部获取一个任务。</li>
</ul>
<h2 id="使用Fork-Join框架"><a href="#使用Fork-Join框架" class="headerlink" title="使用Fork/Join框架"></a>使用Fork/Join框架</h2><p>让我们通过一个简单的需求来使用下Fork／Join框架，需求是：计算1+2+3+4的结果。</p>
<p>使用Fork／Join框架首先要考虑到的是如何分割任务，如果我们希望每个子任务最多执行两个数的相加，那么我们设置分割的阈值是2，由于是4个数字相加，所以Fork／Join框架会把这个任务fork成两个子任务，子任务一负责计算1+2，子任务二负责计算3+4，然后再join两个子任务的结果。</p>
<p>因为是有结果的任务，所以必须继承RecursiveTask，实现代码如下：</p>
<pre><code>001    packagefj;
002     
003    importjava.util.concurrent.ExecutionException;
004     
005    importjava.util.concurrent.ForkJoinPool;
006     
007    importjava.util.concurrent.Future;
008     
009    importjava.util.concurrent.RecursiveTask;
010     
011    publicclassCountTaskextendsRecursiveTask {
012     
013           privatestaticfinalintTHRESHOLD= 2;//阈值
014     
015           privateintstart;
016     
017           privateintend;
018     
019           publicCountTask(intstart,intend) {
020     
021                       this.start= start;
022     
023                       this.end= end;
024     
025            }
026     
027           @Override
028     
029           protectedInteger compute() {
030     
031                       intsum = 0;
032     
033                       //如果任务足够小就计算任务
034     
035                       booleancanCompute = (end-start) &lt;=THRESHOLD;
036     
037                       if(canCompute) {
038     
039                                  for(inti =start; i &lt;=end; i++) {
040     
041                                               sum += i;
042     
043                                   }
044     
045                        }else{
046     
047                                  //如果任务大于阀值，就分裂成两个子任务计算
048     
049                                  intmiddle = (start+end) / 2;
050     
051                                   CountTask leftTask =newCountTask(start, middle);
052     
053                                   CountTask rightTask =newCountTask(middle + 1,end);
054     
055                                  //执行子任务
056     
057                                   leftTask.fork();
058     
059                                   rightTask.fork();
060     
061                                  //等待子任务执行完，并得到其结果
062     
063                                  intleftResult=leftTask.join();
064     
065                                  intrightResult=rightTask.join();
066     
067                                  //合并子任务
068     
069                                   sum = leftResult  + rightResult;
070     
071                        }
072     
073                       returnsum;
074     
075            }
076     
077           publicstaticvoidmain(String[] args) {
078     
079                        ForkJoinPool forkJoinPool =newForkJoinPool();
080     
081                       //生成一个计算任务，负责计算1+2+3+4
082     
083                        CountTask task =newCountTask(1, 4);
084     
085                       //执行一个任务
086     
087                        Future result = forkJoinPool.submit(task);
088     
089                       try{
090     
091                                   System.out.println(result.get());
092     
093                        }catch(InterruptedException e) {
094     
095                        }catch(ExecutionException e) {
096     
097                        }
098     
099            }
100     
101    }
</code></pre><p>通过这个例子让我们再来进一步了解ForkJoinTask，ForkJoinTask与一般的任务的主要区别在于它需要实现compute方法，在这个方法里，首先需要判断任务是否足够小，如果足够小就直接执行任务。如果不足够小，就必须分割成两个子任务，每个子任务在调用fork方法时，又会进入compute方法，看看当前子任务是否需要继续分割成孙任务，如果不需要继续分割，则执行当前子任务并返回结果。使用join方法会等待子任务执行完并得到其结果。</p>
<h2 id="Fork-Join框架的异常处理"><a href="#Fork-Join框架的异常处理" class="headerlink" title="Fork/Join框架的异常处理"></a>Fork/Join框架的异常处理</h2><p>ForkJoinTask在执行的时候可能会抛出异常，但是我们没办法在主线程里直接捕获异常，所以ForkJoinTask提供了isCompletedAbnormally()方法来检查任务是否已经抛出异常或已经被取消了，并且可以通过ForkJoinTask的getException方法获取异常。使用如下代码：</p>
<pre>if(task.isCompletedAbnormally())
{
    System.out.println(task.getException());
}</pre>

<p>getException方法返回Throwable对象，如果任务被取消了则返回CancellationException。如果任务没有完成或者没有抛出异常则返回null。</p>
<h2 id="Fork-Join框架的实现原理"><a href="#Fork-Join框架的实现原理" class="headerlink" title="Fork/Join框架的实现原理"></a>Fork/Join框架的实现原理</h2><p>ForkJoinPool由ForkJoinTask数组和ForkJoinWorkerThread数组组成，ForkJoinTask数组负责存放程序提交给ForkJoinPool的任务，而ForkJoinWorkerThread数组负责执行这些任务。</p>
<p>ForkJoinTask的fork方法实现原理。当我们调用ForkJoinTask的fork方法时，程序会调用ForkJoinWorkerThread的pushTask方法异步的执行这个任务，然后立即返回结果。代码如下：</p>
<pre><code>1    public final ForkJoinTask fork() {
2            ((ForkJoinWorkerThread) Thread.currentThread())
3                .pushTask(this);
4            return this;
5    }
</code></pre><p>pushTask方法把当前任务存放在ForkJoinTask 数组queue里。然后再调用ForkJoinPool的signalWork()方法唤醒或创建一个工作线程来执行任务。代码如下：</p>
<pre><code>01    final void pushTask(ForkJoinTask t) {
02            ForkJoinTask[] q; int s, m;
03            if ((q = queue) != null) {    // ignore if queue removed
04                long u = (((s = queueTop) &amp; (m = q.length - 1)) &lt;&lt; ASHIFT) + ABASE;
05                UNSAFE.putOrderedObject(q, u, t);
06                queueTop = s + 1;         // or use putOrderedInt
07                if ((s -= queueBase) &lt;= 2)
08                    pool.signalWork();
09        else if (s == m)
10                    growQueue();
11            }
12        }
</code></pre><p>ForkJoinTask的join方法实现原理。Join方法的主要作用是阻塞当前线程并等待获取结果。让我们一起看看ForkJoinTask的join方法的实现，代码如下：</p>
<pre><code>public final V join() {
02            if (doJoin() != NORMAL)
03                return reportResult();
04            else
05                return getRawResult();
06    }
07    private V reportResult() {
08            int s; Throwable ex;
09            if ((s = status) == CANCELLED)
10                throw new CancellationException();
11    if (s == EXCEPTIONAL &amp;&amp; (ex = getThrowableException()) != null)
12                UNSAFE.throwException(ex);
13            return getRawResult();
14    }
</code></pre><p>首先，它调用了doJoin()方法，通过doJoin()方法得到当前任务的状态来判断返回什么结果，任务状态有四种：已完成（NORMAL），被取消（CANCELLED），信号（SIGNAL）和出现异常（EXCEPTIONAL）。</p>
<ul>
<li>如果任务状态是已完成，则直接返回任务结果。</li>
<li>如果任务状态是被取消，则直接抛出CancellationException。</li>
<li>如果任务状态是抛出异常，则直接抛出对应的异常。</li>
</ul>
<p>让我们再来分析下doJoin()方法的实现代码：</p>
<p>01    private int doJoin() {<br>02            Thread t; ForkJoinWorkerThread w; int s; booleancompleted;<br>03            if ((t = Thread.currentThread()) instanceofForkJoinWorkerThread) {<br>04                if ((s = status) &lt; 0)<br>05     return s;<br>06                if ((w = (ForkJoinWorkerThread)t).unpushTask(this)) {<br>07                    try {<br>08                        completed = exec();<br>09                    } catch (Throwable rex) {<br>10                        return setExceptionalCompletion(rex);<br>11                    }<br>12                    if (completed)<br>13                        return setCompletion(NORMAL);<br>14                }<br>15                return w.joinTask(this);<br>16            }<br>17            else<br>18                return externalAwaitDone();<br>19        }</p>
<p>在doJoin()方法里，首先通过查看任务的状态，看任务是否已经执行完了，如果执行完了，则直接返回任务状态，如果没有执行完，则从任务数组里取出任务并执行。如果任务顺利执行完成了，则设置任务状态为NORMAL，如果出现异常，则纪录异常，并将任务状态设置为EXCEPTIONAL。</p>
<h2 id="Fork-Join源码剖析与算法解析"><a href="#Fork-Join源码剖析与算法解析" class="headerlink" title="Fork/Join源码剖析与算法解析"></a>Fork/Join源码剖析与算法解析</h2><p>我们在大学算法课本上，学过的一种基本算法就是：分治。其基本思路就是：把一个大的任务分成若干个子任务，这些子任务分别计算，最后再Merge出最终结果。这个过程通常都会用到递归。</p>
<p>而Fork/Join其实就是一种利用多线程来实现“分治算法”的并行框架。</p>
<p>另外一方面，可以把Fori/Join看作一个单机版的Map/Reduce，只不过这里的并行不是多台机器并行计算，而是多个线程并行计算。</p>
<p>下面看2个简单例子：</p>
<p>例子1： 快排<br>我们都知道，快排有2个步骤：<br>第1步，拿数组的第1个元素，把元素划分成2半，左边的比该元素小，右边的比该元素大；<br>第2步，对左右的2个子数组，分别排序。</p>
<p>可以看出，这里左右2个子数组，可以相互独立的，并行计算。因此可以利用ForkJoin框架， 代码如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//定义一个Task，基础自RecursiveAction，实现其compute方法</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SortTask</span> <span class="title">extends</span> <span class="title">RecursiveAction</span> &#123;</span></span><br><span class="line">    final <span class="keyword">long</span>[] <span class="built_in">array</span>;</span><br><span class="line">    final <span class="keyword">int</span> lo;</span><br><span class="line">    final <span class="keyword">int</span> hi;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> THRESHOLD = <span class="number">0</span>; <span class="comment">//For demo only</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SortTask</span><span class="params">(<span class="keyword">long</span>[] <span class="built_in">array</span>)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.<span class="built_in">array</span> = <span class="built_in">array</span>;</span><br><span class="line">        <span class="keyword">this</span>.lo = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">this</span>.hi = <span class="built_in">array</span>.length - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SortTask</span><span class="params">(<span class="keyword">long</span>[] <span class="built_in">array</span>, <span class="keyword">int</span> lo, <span class="keyword">int</span> hi)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.<span class="built_in">array</span> = <span class="built_in">array</span>;</span><br><span class="line">        <span class="keyword">this</span>.lo = lo;</span><br><span class="line">        <span class="keyword">this</span>.hi = hi;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">compute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (hi - lo &lt; THRESHOLD)</span><br><span class="line">            sequentiallySort(<span class="built_in">array</span>, lo, hi);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> pivot = partition(<span class="built_in">array</span>, lo, hi);  <span class="comment">//划分</span></span><br><span class="line">            coInvoke(<span class="keyword">new</span> SortTask(<span class="built_in">array</span>, lo, pivot - <span class="number">1</span>), <span class="keyword">new</span> SortTask(<span class="built_in">array</span>,</span><br><span class="line">                    pivot + <span class="number">1</span>, hi));  <span class="comment">//递归调，左右2个子数组</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">partition</span><span class="params">(<span class="keyword">long</span>[] <span class="built_in">array</span>, <span class="keyword">int</span> lo, <span class="keyword">int</span> hi)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> x = <span class="built_in">array</span>[hi];</span><br><span class="line">        <span class="keyword">int</span> i = lo - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = lo; j &lt; hi; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">array</span>[j] &lt;= x) &#123;</span><br><span class="line">                i++;</span><br><span class="line">                swap(<span class="built_in">array</span>, i, j);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        swap(<span class="built_in">array</span>, i + <span class="number">1</span>, hi);</span><br><span class="line">        <span class="keyword">return</span> i + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">swap</span><span class="params">(<span class="keyword">long</span>[] <span class="built_in">array</span>, <span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (i != j) &#123;</span><br><span class="line">            <span class="keyword">long</span> temp = <span class="built_in">array</span>[i];</span><br><span class="line">            <span class="built_in">array</span>[i] = <span class="built_in">array</span>[j];</span><br><span class="line">            <span class="built_in">array</span>[j] = temp;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sequentiallySort</span><span class="params">(<span class="keyword">long</span>[] <span class="built_in">array</span>, <span class="keyword">int</span> lo, <span class="keyword">int</span> hi)</span> </span>&#123;</span><br><span class="line">        Arrays.sort(<span class="built_in">array</span>, lo, hi + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//测试函数</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSort</span><span class="params">()</span> throws Exception </span>&#123;</span><br><span class="line">        ForkJoinTask sort = <span class="keyword">new</span> SortTask(<span class="built_in">array</span>);   <span class="comment">//1个任务</span></span><br><span class="line">        ForkJoinPool fjpool = <span class="keyword">new</span> ForkJoinPool();  <span class="comment">//1个ForkJoinPool</span></span><br><span class="line">        fjpool.submit(sort); <span class="comment">//提交任务</span></span><br><span class="line">        fjpool.shutdown(); <span class="comment">//结束。ForkJoinPool内部会开多个线程，并行上面的子任务</span></span><br><span class="line"></span><br><span class="line">        fjpool.awaitTermination(<span class="number">30</span>, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>例子2： 求1到n个数的和</p>
<figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//定义一个Task，基础自RecursiveTask，实现其commpute方法</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SumTask</span> <span class="keyword">extends</span> <span class="title">RecursiveTask</span>&lt;<span class="title">Long</span>&gt;</span>&#123;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> THRESHOLD = <span class="number">10</span>;  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> start;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> end;  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> SumTask(<span class="keyword">long</span> n) &#123;  </span><br><span class="line">        <span class="keyword">this</span>(<span class="number">1</span>,n);  </span><br><span class="line">    &#125;  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> SumTask(<span class="keyword">long</span> start, <span class="keyword">long</span> end) &#123;  </span><br><span class="line">        <span class="keyword">this</span>.start = start;  </span><br><span class="line">        <span class="keyword">this</span>.end = end;  </span><br><span class="line">    &#125;  </span><br><span class="line"></span><br><span class="line">    @Override  <span class="comment">//有返回值</span></span><br><span class="line">    <span class="keyword">protected</span> Long compute() &#123;  </span><br><span class="line">        <span class="keyword">long</span> <span class="keyword">sum</span> = <span class="number">0</span>;  </span><br><span class="line">        <span class="keyword">if</span>((end - start) &lt;= THRESHOLD)&#123;  </span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">long</span> l = start; l &lt;= end; l++)&#123;  </span><br><span class="line">                <span class="keyword">sum</span> += l;  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;  </span><br><span class="line">            <span class="keyword">long</span> mid = (start + end) &gt;&gt;&gt; <span class="number">1</span>;  </span><br><span class="line">            SumTask left = <span class="keyword">new</span> SumTask(start, mid);   <span class="comment">//分治，递归</span></span><br><span class="line">            SumTask right = <span class="keyword">new</span> SumTask(mid + <span class="number">1</span>, end);  </span><br><span class="line">            left.fork();  </span><br><span class="line">            right.fork();  </span><br><span class="line">            <span class="keyword">sum</span> = left.join() + right.join();  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">sum</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1</span>L;  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="comment">//测试函数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> testSum() throws Exception &#123;</span><br><span class="line">        SumTask <span class="keyword">sum</span> = <span class="keyword">new</span> SumTask(<span class="number">100</span>);   <span class="comment">//1个任务</span></span><br><span class="line">        ForkJoinPool fjpool = <span class="keyword">new</span> ForkJoinPool();  <span class="comment">//1个ForkJoinPool</span></span><br><span class="line">        Future&lt;Long&gt; future = fjpool.submit(<span class="keyword">sum</span>); <span class="comment">//提交任务</span></span><br><span class="line">        Long r = future.get(); <span class="comment">//获取返回值</span></span><br><span class="line">        fjpool.shutdown(); </span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>与ThreadPool的区别</p>
<p>通过上面例子，我们可以看出，它在使用上，和ThreadPool有共同的地方，也有区别点：<br>（1） ThreadPool只有“外部任务”，也就是调用者放到队列里的任务。 ForkJoinPool有“外部任务”，还有“内部任务”，也就是任务自身在执行过程中，分裂出”子任务“，递归，再次放入队列。<br>（2）ForkJoinPool里面的任务通常有2类，RecusiveAction/RecusiveTask，这2个都是继承自FutureTask。在使用的时候，重写其compute算法。</p>
<p>工作窃取算法</p>
<p>上面提到，ForkJoinPool里有”外部任务“，也有“内部任务”。其中外部任务，是放在ForkJoinPool的全局队列里面，而每个Worker线程，也有一个自己的队列，用于存放内部任务。</p>
<p>窃取的基本思路就是：当worker自己的任务队列里面没有任务时，就去scan别的线程的队列，把别人的任务拿过来执行。</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ForkJoinPool的成员变量</span></span><br><span class="line">ForkJoinWorkerThread[] workers;  <span class="comment">//worker thread集合</span></span><br><span class="line"><span class="keyword">private</span> ForkJoinTask&lt;?&gt;[] submissionQueue; <span class="comment">//外部任务队列</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ReentrantLock submissionLock; </span><br><span class="line"></span><br><span class="line"><span class="comment">//ForkJoinWorkerThread的成员变量</span></span><br><span class="line">ForkJoinTask&lt;?&gt;[] queue;   <span class="comment">//每个worker线程自己的内部任务队列</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//提交任务</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; ForkJoinTask&lt;T&gt; submit(ForkJoinTask&lt;T&gt; <span class="keyword">task</span>) &#123;  </span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">task</span> == <span class="keyword">null</span>)  </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();  </span><br><span class="line">    forkOrSubmit(<span class="keyword">task</span>);  </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">task</span>;  </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> &lt;T&gt; <span class="keyword">void</span> forkOrSubmit(ForkJoinTask&lt;T&gt; <span class="keyword">task</span>) &#123;  </span><br><span class="line">    ForkJoinWorkerThread w;  </span><br><span class="line">    Thread t = Thread.currentThread();  </span><br><span class="line">    <span class="keyword">if</span> (shutdown)  </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RejectedExecutionException();  </span><br><span class="line">    <span class="keyword">if</span> ((t <span class="keyword">instanceof</span> ForkJoinWorkerThread) &amp;&amp;   <span class="comment">//如果当前是worker线程提交的任务，也就是worker执行过程中，分裂出来的子任务，放入worker自己的内部任务队列</span></span><br><span class="line">        (w = (ForkJoinWorkerThread)t).pool == <span class="keyword">this</span>)  </span><br><span class="line">        w.pushTask(<span class="keyword">task</span>);  </span><br><span class="line">    <span class="keyword">else</span>  </span><br><span class="line">        addSubmission(<span class="keyword">task</span>);  <span class="comment">//外部任务，放入pool的全局队列</span></span><br><span class="line">&#125;   </span><br><span class="line"></span><br><span class="line"><span class="comment">//worker的run方法</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> run() &#123;  </span><br><span class="line">    Throwable exception = <span class="keyword">null</span>;  </span><br><span class="line">    <span class="keyword">try</span> &#123;  </span><br><span class="line">        onStart();  </span><br><span class="line">        pool.work(<span class="keyword">this</span>);  </span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable ex) &#123;  </span><br><span class="line">        exception = ex;  </span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;  </span><br><span class="line">        onTermination(exception);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> work(ForkJoinWorkerThread w) &#123;  </span><br><span class="line">    <span class="keyword">boolean</span> swept = <span class="keyword">false</span>;                <span class="comment">// true on empty scans  </span></span><br><span class="line">    <span class="keyword">long</span> c;  </span><br><span class="line">    <span class="keyword">while</span> (!w.terminate &amp;&amp; (<span class="keyword">int</span>)(c = ctl) &gt;= <span class="number">0</span>) &#123;  </span><br><span class="line">        <span class="keyword">int</span> a;                            <span class="comment">// active count  </span></span><br><span class="line">        <span class="keyword">if</span> (!swept &amp;&amp; (a = (<span class="keyword">int</span>)(c &gt;&gt; AC_SHIFT)) &lt;= <span class="number">0</span>)  </span><br><span class="line">            swept = scan(w, a);   <span class="comment">//核心代码都在这个scan函数里面</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (tryAwaitWork(w, c))  </span><br><span class="line">            swept = <span class="keyword">false</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="comment">//scan的基本思路：从别人的任务队列里面抢，没有，再到pool的全局的任务队列里面去取。</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> scan(ForkJoinWorkerThread w, <span class="keyword">int</span> a) &#123;  </span><br><span class="line">    <span class="keyword">int</span> g = scanGuard;   </span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> m = (parallelism == <span class="number">1</span> - a &amp;&amp; blockedCount == <span class="number">0</span>) ? <span class="number">0</span> : g &amp; SMASK;  </span><br><span class="line">    ForkJoinWorkerThread[] ws = workers;  </span><br><span class="line">    <span class="keyword">if</span> (ws == <span class="keyword">null</span> || ws.length &lt;= m)         <span class="comment">// 过期检测  </span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> r = w.seed, k = r, j = -(m + m); j &lt;= m + m; ++j) &#123;  </span><br><span class="line">        ForkJoinTask&lt;?&gt; t; ForkJoinTask&lt;?&gt;[] q; <span class="keyword">int</span> b, i;  </span><br><span class="line">        <span class="comment">//随机选出一个牺牲者(工作线程)。  </span></span><br><span class="line">        ForkJoinWorkerThread v = ws[k &amp; m];  </span><br><span class="line">        <span class="comment">//一系列检查...  </span></span><br><span class="line">        <span class="keyword">if</span> (v != <span class="keyword">null</span> &amp;&amp; (b = v.queueBase) != v.queueTop &amp;&amp;  </span><br><span class="line">            (q = v.queue) != <span class="keyword">null</span> &amp;&amp; (i = (q.length - <span class="number">1</span>) &amp; b) &gt;= <span class="number">0</span>) &#123;  </span><br><span class="line">            <span class="comment">//如果这个牺牲者的任务队列中还有任务，尝试窃取这个任务。  </span></span><br><span class="line">            <span class="keyword">long</span> u = (i &lt;&lt; ASHIFT) + ABASE;  </span><br><span class="line">            <span class="keyword">if</span> ((t = q[i]) != <span class="keyword">null</span> &amp;&amp; v.queueBase == b &amp;&amp;  </span><br><span class="line">                UNSAFE.compareAndSwapObject(q, u, t, <span class="keyword">null</span>)) &#123;  </span><br><span class="line">                <span class="comment">//窃取成功后，调整queueBase  </span></span><br><span class="line">                <span class="keyword">int</span> d = (v.queueBase = b + <span class="number">1</span>) - v.queueTop;  </span><br><span class="line">                <span class="comment">//将牺牲者的stealHint设置为当前工作线程在pool中的下标。  </span></span><br><span class="line">                v.stealHint = w.poolIndex;  </span><br><span class="line">                <span class="keyword">if</span> (d != <span class="number">0</span>)  </span><br><span class="line">                    signalWork();             <span class="comment">// 如果牺牲者的任务队列还有任务，继续唤醒(或创建)线程。  </span></span><br><span class="line">                w.execTask(t); <span class="comment">//执行窃取的任务。  </span></span><br><span class="line">            &#125;  </span><br><span class="line">            <span class="comment">//计算出下一个随机种子。  </span></span><br><span class="line">            r ^= r &lt;&lt; <span class="number">13</span>; r ^= r &gt;&gt;&gt; <span class="number">17</span>; w.seed = r ^ (r &lt;&lt; <span class="number">5</span>);  </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;                     <span class="comment">// 返回false，表示不是一个空扫描。  </span></span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="comment">//前2*m次，随机扫描。  </span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (j &lt; <span class="number">0</span>) &#123;                     <span class="comment">// xorshift  </span></span><br><span class="line">            r ^= r &lt;&lt; <span class="number">13</span>; r ^= r &gt;&gt;&gt; <span class="number">17</span>; k = r ^= r &lt;&lt; <span class="number">5</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="comment">//后2*m次，顺序扫描。  </span></span><br><span class="line">        <span class="keyword">else</span>  </span><br><span class="line">            ++k;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">if</span> (scanGuard != g)                       <span class="comment">// staleness check  </span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;  </span><br><span class="line">    <span class="keyword">else</span> &#123;                                     </span><br><span class="line">        <span class="comment">//如果扫描完毕后没找到可窃取的任务，那么从Pool的提交任务队列中取一个任务来执行。  </span></span><br><span class="line">        ForkJoinTask&lt;?&gt; t; ForkJoinTask&lt;?&gt;[] q; <span class="keyword">int</span> b, i;  </span><br><span class="line">        <span class="keyword">if</span> ((b = queueBase) != queueTop &amp;&amp;  </span><br><span class="line">            (q = submissionQueue) != <span class="keyword">null</span> &amp;&amp;  </span><br><span class="line">            (i = (q.length - <span class="number">1</span>) &amp; b) &gt;= <span class="number">0</span>) &#123;  </span><br><span class="line">            <span class="keyword">long</span> u = (i &lt;&lt; ASHIFT) + ABASE;  </span><br><span class="line">            <span class="keyword">if</span> ((t = q[i]) != <span class="keyword">null</span> &amp;&amp; queueBase == b &amp;&amp;  </span><br><span class="line">                UNSAFE.compareAndSwapObject(q, u, t, <span class="keyword">null</span>)) &#123;  </span><br><span class="line">                queueBase = b + <span class="number">1</span>;  </span><br><span class="line">                w.execTask(t);  </span><br><span class="line">            &#125;  </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;                         <span class="comment">// 如果所有的队列(工作线程的任务队列和pool的任务队列)都是空的，返回true。  </span></span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关于ForkJoinPool/FutureTask，本文只是分析了其基本使用原理。还有很多实现细节，留待读者自己去分析。</p>

      
    </div>
    
    
    

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    h2pl
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://h2pl.github.io/2018/05/24/concurrent15/" title="Java并发指南15：Fork join并发框架与工作窃取算法剖析">http://h2pl.github.io/2018/05/24/concurrent15/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Java并发/" rel="tag"># Java并发</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/05/24/concurrent14/" rel="next" title="Java并发指南14：Java并发容器ConcurrentSkipListMap与CopyOnWriteArrayList">
                <i class="fa fa-chevron-left"></i> Java并发指南14：Java并发容器ConcurrentSkipListMap与CopyOnWriteArrayList
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/05/25/Javanet/" rel="prev" title="Java网络编程和NIO详解开篇：Java网络编程基础">
                Java网络编程和NIO详解开篇：Java网络编程基础 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC8zNTkxMC8xMjQ0Ng=="></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="h2pl" />
            
              <p class="site-author-name" itemprop="name">h2pl</p>
              <p class="site-description motion-element" itemprop="description">Java后端开发之路</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">95</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">9</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">33</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/h2pl" target="_blank" title="Github">
                      
                        <i class="fa fa-fw fa-github"></i>Github</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:362294931@qq.com" target="_blank" title="Email">
                      
                        <i class="fa fa-fw fa-envelope"></i>Email</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.zhihu.com/people/h2pl" target="_blank" title="知乎">
                      
                        <i class="fa fa-fw fa-gratipay"></i>知乎</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://blog.csdn.net/a724888" target="_blank" title="CSDN">
                      
                        <i class="fa fa-fw fa-globe"></i>CSDN</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                友情链接
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.jianshu.com/users/9ab8d7b38c4e" title="我的简书" target="_blank">我的简书</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#什么是Fork-Join框架"><span class="nav-number">1.</span> <span class="nav-text">什么是Fork/Join框架</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#工作窃取算法"><span class="nav-number">2.</span> <span class="nav-text">工作窃取算法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Fork-Join框架的介绍"><span class="nav-number">3.</span> <span class="nav-text">Fork/Join框架的介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用Fork-Join框架"><span class="nav-number">4.</span> <span class="nav-text">使用Fork/Join框架</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Fork-Join框架的异常处理"><span class="nav-number">5.</span> <span class="nav-text">Fork/Join框架的异常处理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Fork-Join框架的实现原理"><span class="nav-number">6.</span> <span class="nav-text">Fork/Join框架的实现原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Fork-Join源码剖析与算法解析"><span class="nav-number">7.</span> <span class="nav-text">Fork/Join源码剖析与算法解析</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">h2pl

  &nbsp;&nbsp;|&nbsp;&nbsp;
  <script type="text/javascript">
    var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");
    document.write('站长统计'' type='text/javascript'%3E%3C/script%3E"));
  </script>

  &nbsp;&nbsp;|&nbsp;&nbsp;<span><a href="/sitemap.xml">Google网站地图</a></span>
  &nbsp;&nbsp;|&nbsp;&nbsp;<span><a href="/baidusitemap.xml">百度网站地图</a></span>

  </span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


&nbsp;&nbsp;|&nbsp;&nbsp;本站总点击 <span id="busuanzi_value_site_pv"></span> 次
&nbsp;&nbsp;|&nbsp;&nbsp;您是第 <span id="busuanzi_value_site_uv"></span> 位访客

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

<script>
(function(){
    var bp = document.createElement('script');
    bp.src = '//push.zhanzhang.baidu.com/push.js';
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  












  





  

  

  

  
  

  

  

  

    <!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/love.js"></script>

</body>
</html>
