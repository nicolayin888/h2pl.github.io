<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Spring IOC," />





  <link rel="alternate" href="/atom.xml" title="How 2 Play Life" type="application/atom+xml" />






<meta name="description" content="本系列文章首发于我的个人博客：https://h2pl.github.io/ 欢迎阅览我的CSDN专栏：Spring源码解析 https://blog.csdn.net/column/details/21851.html 部分代码会放在我的的Github：https://github.com/h2pl/://github.com/h2pl/">
<meta name="keywords" content="Spring IOC">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring源码剖析2：Spring IOC容器的加载过程">
<meta property="og:url" content="http://h2pl.github.io/2018/06/02/spring2/index.html">
<meta property="og:site_name" content="How 2 Play Life">
<meta property="og:description" content="本系列文章首发于我的个人博客：https://h2pl.github.io/ 欢迎阅览我的CSDN专栏：Spring源码解析 https://blog.csdn.net/column/details/21851.html 部分代码会放在我的的Github：https://github.com/h2pl/://github.com/h2pl/">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/2836699-357e2bd46ff6f5fc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/700">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/2836699-f869abb0045bb989.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/700">
<meta property="og:updated_time" content="2018-06-11T14:29:28.998Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Spring源码剖析2：Spring IOC容器的加载过程">
<meta name="twitter:description" content="本系列文章首发于我的个人博客：https://h2pl.github.io/ 欢迎阅览我的CSDN专栏：Spring源码解析 https://blog.csdn.net/column/details/21851.html 部分代码会放在我的的Github：https://github.com/h2pl/://github.com/h2pl/">
<meta name="twitter:image" content="https://upload-images.jianshu.io/upload_images/2836699-357e2bd46ff6f5fc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/700">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"hide","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://h2pl.github.io/2018/06/02/spring2/"/>





  <title>Spring源码剖析2：Spring IOC容器的加载过程 | How 2 Play Life</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

	<a href="https://github.com/h2pl"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub"></a>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">How 2 Play Life</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Java后端开发之路</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://h2pl.github.io/2018/06/02/spring2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="h2pl">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="How 2 Play Life">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Spring源码剖析2：Spring IOC容器的加载过程</h1>
        

        <div class="post-meta">
        
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-02T22:27:48+08:00">
                2018-06-02
              </time>
            

            

            
          </span>

          
            <span id="busuanzi_container_page_pv">&nbsp;&nbsp;|&nbsp;&nbsp;阅读量 <span id="busuanzi_value_page_pv"></span> 次</span>
          

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/后端/" itemprop="url" rel="index">
                    <span itemprop="name">后端</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/后端/Spring/" itemprop="url" rel="index">
                    <span itemprop="name">Spring</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  7,213
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>本系列文章首发于我的个人博客：<a href="https://h2pl.github.io/">https://h2pl.github.io/</a></p>
<p>欢迎阅览我的CSDN专栏：Spring源码解析 <a href="https://blog.csdn.net/column/details/21851.html" target="_blank" rel="noopener">https://blog.csdn.net/column/details/21851.html</a></p>
<p>部分代码会放在我的的Github：<a href="https://github.com/h2pl/" target="_blank" rel="noopener">https://github.com/h2pl/</a><br>://github.com/h2pl/</p>
<a id="more"></a>
<h1 id="spring-ioc-容器的加载流程"><a href="#spring-ioc-容器的加载流程" class="headerlink" title="spring ioc 容器的加载流程"></a>spring ioc 容器的加载流程</h1><p><strong>1.目标：</strong>熟练使用spring，并分析其源码，了解其中的思想。这篇主要介绍spring ioc 容器的加载</p>
<p><strong>2.前提条件：</strong>会使用debug</p>
<p><strong>3.源码分析方法：</strong>Intellj idea debug 模式下源码追溯<br>通过ClassPathXmlApplicationContext 进行xml 件的读取，从每个堆栈中读取程序的运行信息</p>
<p><strong>4.注意：</strong>由于Spring的类继承体系比较复杂,不能全部贴图，所以只将分析源码之后发现的最主要的类继承结构类图贴在下方。</p>
<p><strong>5.关于Spring Ioc<br>Demo：</strong>我们从demo入手一步步进行代码追溯。</p>
<h2 id="Spring-Ioc-Demo"><a href="#Spring-Ioc-Demo" class="headerlink" title="Spring Ioc Demo"></a>Spring Ioc Demo</h2><hr>
<blockquote>
<p>1.定义数据访问接口IUserDao.java</p>
</blockquote>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public<span class="built_in"> interface </span>IUserDao &#123;  </span><br><span class="line">    public void InsertUser(String username,String password);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2.定义IUserDao.java实现类IUserDaoImpl.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDaoImpl</span> <span class="keyword">implements</span> <span class="title">IUserDao</span> </span>&#123;    </span><br><span class="line">    <span class="meta">@Override</span>    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">InsertUser</span><span class="params">(String username, String password)</span> </span>&#123; </span><br><span class="line">        System.out.println(<span class="string">"----UserDaoImpl --addUser----"</span>);    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3.定义业务逻辑接口UserService.java</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public<span class="built_in"> interface </span>UserService &#123;    </span><br><span class="line">    public void addUser(String username,String password);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>4.定义UserService.java实现类UserServiceImpl.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;    </span><br><span class="line">    <span class="keyword">private</span>     IUserDao  userDao;    <span class="comment">//set方法  </span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span>  <span class="title">setUserDao</span><span class="params">(IUserDao  userDao)</span> </span>&#123;        </span><br><span class="line">        <span class="keyword">this</span>.userDao = userDao;   </span><br><span class="line">    &#125;    </span><br><span class="line">    <span class="meta">@Override</span>    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addUser</span><span class="params">(String username,String password)</span> </span>&#123; </span><br><span class="line">        userDao.InsertUser(username,password);    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>bean.xml配置文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span>  </span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span>    </span></span><br><span class="line"><span class="tag">   <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans  </span></span></span><br><span class="line"><span class="tag"><span class="string">http://www.springframework.org/schema/beans/spring-beans-3.0.xsd         "</span>&gt;</span>  </span><br><span class="line"> <span class="comment">&lt;!--id名字自己取，class表示他代表的类，如果在包里的话需要加上包名--&gt;</span>    </span><br><span class="line"> <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"userService"</span>  <span class="attr">class</span>=<span class="string">"UserServiceImpl"</span> &gt;</span>      </span><br><span class="line">        <span class="comment">&lt;!--property代表是通过set方法注入,ref的值表示注入的内容--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span>  <span class="attr">name</span>=<span class="string">"userDao"</span>  <span class="attr">ref</span>=<span class="string">"userDao"</span>/&gt;</span>  </span><br><span class="line"> <span class="tag">&lt;/<span class="name">bean</span>&gt;</span>    </span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"userDao"</span>  <span class="attr">class</span>=<span class="string">"UserDaoImpl"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="ApplicationContext-继承结构"><a href="#ApplicationContext-继承结构" class="headerlink" title="ApplicationContext 继承结构"></a>ApplicationContext 继承结构</h2><hr>
<blockquote>
<p>1.顶层接口：ApplicationContext<br>2.ClassPathXmlApplicationContext实现类继承AbstractXmlApplication 抽象类<br>3.AbstractXmlApplication 继承AbstractRefreshableConfigApplicationContext<br>4.AbstractRefreshableConfigApplicationContext抽象类继承AbstractRefreshableApplicationContext<br>5.AbstractRefreshableApplicationContext 继承 AbstractApplicationContext<br>6.AbstractApplicationContext 实现ConfigurableApplicationContext 接口<br>7.ConfigurableApplicationContext 接口继承<br>ApplicationContext接口<br>总体来说继承实现结构较深，内部使用了大量适配器模式。<br>以ClassPathXmlApplicationContext为例，继承类图如下图所示：</p>
<p><img src="https://upload-images.jianshu.io/upload_images/2836699-357e2bd46ff6f5fc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/700" alt=""></p>
</blockquote>
<h2 id="Spring-Ioc容器加载过程源码详解"><a href="#Spring-Ioc容器加载过程源码详解" class="headerlink" title="Spring Ioc容器加载过程源码详解"></a>Spring Ioc容器加载过程源码详解</h2><hr>
<p>在开始之前，先介绍一个整体的概念。即spring ioc容器的加载，大体上经过以下几个过程：<br>资源文件定位、解析、注册、实例化</p>
<blockquote>
<p><strong>1.资源文件定位</strong><br>其中资源文件定位，一般是在ApplicationContext的实现类里完成的，因为ApplicationContext接口继承ResourcePatternResolver 接口，ResourcePatternResolver接口继承ResourceLoader接口，ResourceLoader其中的getResource()方法，可以将外部的资源，读取为Resource类。</p>
</blockquote>
<hr>
<p><strong>2.解析</strong>DefaultBeanDefinitionDocumentReader，<br>解析主要是在BeanDefinitionReader中完成的，最常用的实现类是XmlBeanDefinitionReader，其中的loadBeanDefinitions()方法，负责读取Resource，并完成后续的步骤。ApplicationContext完成资源文件定位之后，是将解析工作委托给XmlBeanDefinitionReader来完成的<br>解析这里涉及到很多步骤，最常见的情况，资源文件来自一个XML配置文件。首先是BeanDefinitionReader，将XML文件读取成w3c的Document文档。<br>DefaultBeanDefinitionDocumentReader对Document进行进一步解析。然后DefaultBeanDefinitionDocumentReader又委托给BeanDefinitionParserDelegate进行解析。如果是标准的xml namespace元素，会在Delegate内部完成解析，如果是非标准的xml namespace元素，则会委托合适的NamespaceHandler进行解析最终解析的结果都封装为BeanDefinitionHolder，至此解析就算完成。<br><strong>后续会进行细致讲解。</strong></p>
<hr>
<p><strong>3.注册</strong><br>然后bean的注册是在BeanFactory里完成的，BeanFactory接口最常见的一个实现类是DefaultListableBeanFactory，它实现了BeanDefinitionRegistry接口，所以其中的registerBeanDefinition()方法，可以对BeanDefinition进行注册这里附带一提，最常见的XmlWebApplicationContext不是自己持有BeanDefinition的，它继承自AbstractRefreshableApplicationContext，其持有一个DefaultListableBeanFactory的字段，就是用它来保存BeanDefinition<br>所谓的注册，其实就是将BeanDefinition的name和实例，保存到一个Map中。刚才说到，最常用的实现DefaultListableBeanFactory，其中的字段就是beanDefinitionMap，是一个ConcurrentHashMap。<br>代码如下：<br><strong>&gt;1.DefaultListableBeanFactory继承实现关系</strong></p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">DefaultListableBeanFactory</span></span></span><br><span class="line"><span class="class"><span class="keyword">extends</span> </span></span><br><span class="line"><span class="class"><span class="title">AbstractAutowireCapableBeanFactory</span>   </span></span><br><span class="line"><span class="class"><span class="keyword">implements</span></span></span><br><span class="line"><span class="class"><span class="title">ConfigurableListableBeanFactory</span>, </span></span><br><span class="line"><span class="class"><span class="title">BeanDefinitionRegistry</span>,</span></span><br><span class="line"><span class="class"><span class="title">Serializable</span> </span>&#123; </span><br><span class="line">     <span class="comment">// DefaultListableBeanFactory的实例中最终保存了所有注册的bean    beanDefinitionMap</span></span><br><span class="line">     <span class="comment"><span class="markdown">/<span class="emphasis">** Map of bean definition objects, keyed by bean name *</span>/</span></span></span><br><span class="line">     private <span class="keyword">final</span> <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, BeanDefinition&gt; beanDefinitionMap </span><br><span class="line">     = <span class="keyword">new</span> ConcurrentHashMap&lt;<span class="built_in">String</span>, BeanDefinition&gt;(<span class="number">64</span>); </span><br><span class="line">     <span class="comment">//实现BeanDefinitionRegistry中定义的registerBeanDefinition()抽象方法</span></span><br><span class="line">     public <span class="keyword">void</span> registerBeanDefinition(<span class="built_in">String</span> beanName, BeanDefinition    beanDefinition)      throws BeanDefinitionStoreException &#123;</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>
<p><strong>&gt;2.BeanDefinitionRegistry接口</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BeanDefinitionRegistry</span> <span class="keyword">extends</span> <span class="title">AliasRegistry</span> </span>&#123;   </span><br><span class="line">    <span class="comment">//定义注册BeanDefinition实例的抽象方法</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">registerBeanDefinition</span><span class="params">(String beanName, BeanDefinition beanDefinition)</span>         <span class="keyword">throws</span> BeanDefinitionStoreException</span>;</span><br></pre></td></tr></table></figure>
<p><strong>4.实例化</strong></p>
<hr>
<p>注册也完成之后，在BeanFactory的getBean()方法之中，会完成初始化，也就是依赖注入的过程<br>大体上的流程就是这样。</p>
<h1 id="refresh-方法"><a href="#refresh-方法" class="headerlink" title="refresh()方法"></a>refresh()方法</h1><blockquote>
<p><strong>1.目标：</strong><br>这篇记录debug 追溯源码的过程，大概分三个篇幅，这是第一篇，现整体了解一下运行流程，定位资源加载，资源解析，bean 注册发生的位置。<br>2.<strong>记录结构：</strong><br>1.调试栈截图<br>2.整体流程<br>3.bean.xml的处理<br><strong>每段代码下面有相应的讲解</strong></p>
</blockquote>
<h2 id="调试栈截图"><a href="#调试栈截图" class="headerlink" title="调试栈截图"></a>调试栈截图</h2><hr>
<p><img src="https://upload-images.jianshu.io/upload_images/2836699-f869abb0045bb989.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/700" alt=""></p>
<p>每个栈帧中方法的行号都有标明，按照行号追溯源码，然后配合教程能够快速学习。</p>
<h2 id="整体流程"><a href="#整体流程" class="headerlink" title="整体流程"></a>整体流程</h2><hr>
<p>ioc容器实例化代码</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ApplicationContext applicationContext</span> = new ClassPathXmlApplicationContext(<span class="string">"bean.xml"</span>);</span><br></pre></td></tr></table></figure>
<p>进入代码中一步步追溯，发现重要方法：refresh();<br>如下所示：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>.startupShutdownMonitor) &#123;</span><br><span class="line">            <span class="comment">// Prepare this context for refreshing.</span></span><br><span class="line">            prepareRefresh();</span><br><span class="line">            <span class="comment">//beanFactory实例化方法 单步调试入口</span></span><br><span class="line">            <span class="comment">// Tell the subclass to refresh the internal bean factory.</span></span><br><span class="line">            ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Prepare the bean factory for use in this context.</span></span><br><span class="line">            prepareBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// Allows post-processing of the bean factory in context subclasses.</span></span><br><span class="line">                postProcessBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Invoke factory processors registered as beans in the context.</span></span><br><span class="line">                invokeBeanFactoryPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Register bean processors that intercept bean creation.</span></span><br><span class="line">                registerBeanPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Initialize message source for this context.</span></span><br><span class="line">                initMessageSource();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Initialize event multicaster for this context.</span></span><br><span class="line">                initApplicationEventMulticaster();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Initialize other special beans in specific context subclasses.</span></span><br><span class="line">                onRefresh();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Check for listener beans and register them.</span></span><br><span class="line">                registerListeners();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Instantiate all remaining (non-lazy-init) singletons.</span></span><br><span class="line">                finishBeanFactoryInitialization(beanFactory);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Last step: publish corresponding event.</span></span><br><span class="line">                finishRefresh();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">                <span class="comment">// Destroy already created singletons to avoid dangling resources.</span></span><br><span class="line">                destroyBeans();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Reset 'active' flag.</span></span><br><span class="line">                cancelRefresh(ex);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Propagate exception to caller.</span></span><br><span class="line">                <span class="keyword">throw</span> ex;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>首先这个方法是同步的，以避免重复刷新。然后刷新的每个步骤，都放在单独的方法里，比较清晰，可以按顺序一个个看</p>
<p>首先是prepareRefresh()方法</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> void prepareRefresh() &#123;</span><br><span class="line">        <span class="keyword">this</span>.startupDate = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        synchronized (<span class="keyword">this</span>.activeMonitor) &#123;</span><br><span class="line">            <span class="keyword">this</span>.active = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">            logger.info(<span class="string">"Refreshing "</span> + <span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Initialize any placeholder property sources in the context environment</span></span><br><span class="line">        initPropertySources();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Validate that all properties marked as required are resolvable</span></span><br><span class="line">        <span class="comment">// see ConfigurablePropertyResolver#setRequiredProperties</span></span><br><span class="line">        <span class="keyword">this</span>.environment.validateRequiredProperties();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这个方法里做的事情不多，记录了开始时间，输出日志，另外initPropertySources()方法和validateRequiredProperties()方法一般都没有做什么事。</p>
<p>然后是核心的obtainFreshBeanFactory()方法，这个方法是初始化BeanFactory，是整个refresh()方法的核心，其中完成了配置文件的加载、解析、注册，后面会专门详细说 。</p>
<p>这里要说明一下，ApplicationContext实现了BeanFactory接口，并实现了ResourceLoader、MessageSource等接口，可以认为是增强的BeanFactory。但是ApplicationContext并不自己重复实现BeanFactory定义的方法，而是委托给DefaultListableBeanFactory来实现。这种设计思路也是值得学习的。<br>后面的 prepareBeanFactory()、postProcessBeanFactory()、invokeBeanFactoryPostProcessors()、registerBeanPostProcessors()、initMessageSource()、initApplicationEventMulticaster()、onRefresh()、registerListeners()、finishBeanFactoryInitialization()、finishRefresh()等方法，是添加一些后处理器、广播、拦截器等，就不一个个细说了</p>
<p>其中的关键方法是finishBeanFactoryInitialization()，在这个方法中，会对刚才注册的Bean（不延迟加载的），进行实例化，所以也是一个核心方法。</p>
<h2 id="bean-xml的处理"><a href="#bean-xml的处理" class="headerlink" title="bean.xml的处理"></a>bean.xml的处理</h2><hr>
<p>从整体上介绍完了流程，接下来就重点看obtainFreshBeanFactory()方法，上文说到，在这个方法里，完成了配置文件的加载、解析、注册</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">protected ConfigurableListableBeanFactory obtainFreshBeanFactory() &#123;</span><br><span class="line">        refreshBeanFactory()<span class="comment">;</span></span><br><span class="line">        ConfigurableListableBeanFactory <span class="keyword">beanFactory </span>= getBeanFactory()<span class="comment">;</span></span><br><span class="line">        if (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(<span class="string">"Bean factory for "</span> + getDisplayName() + <span class="string">": "</span> + <span class="keyword">beanFactory);</span></span><br><span class="line"><span class="keyword"> </span>       &#125;</span><br><span class="line">        return <span class="keyword">beanFactory;</span></span><br><span class="line"><span class="keyword"> </span>   &#125;</span><br></pre></td></tr></table></figure>
<p>这个方法做了2件事，首先通过refreshBeanFactory()方法，创建了DefaultListableBeanFactory的实例，并进行初始化。</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="function"><span class="keyword">void</span> <span class="title">refreshBeanFactory</span><span class="params">()</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (hasBeanFactory()) &#123;</span><br><span class="line">            destroyBeans();</span><br><span class="line">            closeBeanFactory();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            DefaultListableBeanFactory beanFactory = createBeanFactory();</span><br><span class="line">            beanFactory.setSerializationId(getId());</span><br><span class="line">            customizeBeanFactory(beanFactory);</span><br><span class="line">            loadBeanDefinitions(beanFactory);</span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="keyword">this</span>.beanFactoryMonitor) &#123;</span><br><span class="line">                <span class="keyword">this</span>.beanFactory = beanFactory;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ApplicationContextException(<span class="string">"I/O error parsing bean definition source for "</span> + getDisplayName(), ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>首先如果已经有BeanFactory实例，就先清空。然后通过createBeanFactory()方法，创建一个DefaultListableBeanFactory的实例</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> DefaultListableBeanFactory <span class="title">createBeanFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DefaultListableBeanFactory(getInternalParentBeanFactory());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>接下来设置ID唯一标识</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">beanFactory.setSerializationId(getId())<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>然后允许用户进行一些自定义的配置</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> void customizeBeanFactory(DefaultListableBeanFactory beanFactory) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.allowBeanDefinitionOverriding != <span class="literal">null</span>) &#123;</span><br><span class="line">            beanFactory.setAllowBeanDefinitionOverriding(<span class="keyword">this</span>.allowBeanDefinitionOverriding);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.allowCircularReferences != <span class="literal">null</span>) &#123;</span><br><span class="line">            beanFactory.setAllowCircularReferences(<span class="keyword">this</span>.allowCircularReferences);</span><br><span class="line">        &#125;</span><br><span class="line">        beanFactory.setAutowireCandidateResolver(new QualifierAnnotationAutowireCandidateResolver());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>最后，就是核心的loadBeanDefinitions()方法</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">void</span> <span class="title">loadBeanDefinitions</span><span class="params">(DefaultListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException, IOException </span>&#123;</span><br><span class="line">        <span class="comment">// Create a new XmlBeanDefinitionReader for the given BeanFactory.</span></span><br><span class="line">        XmlBeanDefinitionReader beanDefinitionReader = <span class="keyword">new</span> XmlBeanDefinitionReader(beanFactory);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Configure the bean definition reader with this context's</span></span><br><span class="line">        <span class="comment">// resource loading environment.</span></span><br><span class="line">        beanDefinitionReader.setEnvironment(<span class="keyword">this</span>.getEnvironment());</span><br><span class="line">        beanDefinitionReader.setResourceLoader(<span class="keyword">this</span>);</span><br><span class="line">        beanDefinitionReader.setEntityResolver(<span class="keyword">new</span> ResourceEntityResolver(<span class="keyword">this</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Allow a subclass to provide custom initialization of the reader,</span></span><br><span class="line">        <span class="comment">// then proceed with actually loading the bean definitions.</span></span><br><span class="line">        initBeanDefinitionReader(beanDefinitionReader);</span><br><span class="line">        loadBeanDefinitions(beanDefinitionReader);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这里首先会创建一个XmlBeanDefinitionReader的实例，然后进行初始化。这个XmlBeanDefinitionReader中其实传递的BeanDefinitionRegistry类型的实例，为什么可以传递一个beanFactory呢，因为DefaultListableBeanFactory实现了BeanDefinitionRegistry接口，这里是多态的使用。</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">void</span> <span class="title">loadBeanDefinitions</span><span class="params">(DefaultListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException, IOException </span>&#123;</span><br><span class="line">        <span class="comment">// Create a new XmlBeanDefinitionReader for the given BeanFactory.</span></span><br><span class="line">        XmlBeanDefinitionReader beanDefinitionReader = <span class="keyword">new</span> XmlBeanDefinitionReader(beanFactory);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Configure the bean definition reader with this context's</span></span><br><span class="line">        <span class="comment">// resource loading environment.</span></span><br><span class="line">        beanDefinitionReader.setEnvironment(<span class="keyword">this</span>.getEnvironment());</span><br><span class="line">        beanDefinitionReader.setResourceLoader(<span class="keyword">this</span>);</span><br><span class="line">        beanDefinitionReader.setEntityResolver(<span class="keyword">new</span> ResourceEntityResolver(<span class="keyword">this</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Allow a subclass to provide custom initialization of the reader,</span></span><br><span class="line">        <span class="comment">// then proceed with actually loading the bean definitions.</span></span><br><span class="line">        initBeanDefinitionReader(beanDefinitionReader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里要说明一下，ApplicationContext并不自己负责配置文件的加载、解析、注册，而是将这些工作委托给XmlBeanDefinitionReader来做。</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">loadBeanDefinitions(<span class="name">beanDefinitionReader</span>)<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>这行代码，就是Bean定义读取实际发生的地方。这里的工作，主要是XmlBeanDefinitionReader来完成的，下一篇博客会详细介绍这个过程。</p>
<h1 id="loadBeanDefinitions"><a href="#loadBeanDefinitions" class="headerlink" title="loadBeanDefinitions"></a>loadBeanDefinitions</h1><h2 id="loadBeanDefinitions-源码阅读"><a href="#loadBeanDefinitions-源码阅读" class="headerlink" title="loadBeanDefinitions: 源码阅读"></a>loadBeanDefinitions: 源码阅读</h2><hr>
<p>入口是loadBeanDefinitions方法</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> loadBeanDefinitions(XmlBeanDefinitionReader reader) </span><br><span class="line"><span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">String</span>[] configLocations = getConfigLocations();</span><br><span class="line">        <span class="keyword">if</span> (configLocations != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">String</span> configLocation : configLocations) &#123;</span><br><span class="line">                reader.loadBeanDefinitions(configLocation);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这是解析过程最外围的代码，首先要获取到配置文件的路径，这在之前已经完成了。<br>然后将每个配置文件的路径，作为参数传给BeanDefinitionReader的loadBeanDefinitions方法里</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">int</span> <span class="title">loadBeanDefinitions</span><span class="params">(String location)</span> <span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">return</span> <span class="title">loadBeanDefinitions</span><span class="params">(location, <span class="keyword">null</span>)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法又调用了重载方法</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">int</span> loadBeanDefinitions(<span class="keyword">String</span> location, Set&lt;Resource&gt; actualResources) </span><br><span class="line"><span class="keyword">throws</span> BeanDefinitionStoreException &#123;</span><br><span class="line">        ResourceLoader resourceLoader = getResourceLoader();</span><br><span class="line">        <span class="keyword">if</span> (resourceLoader == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(</span><br><span class="line">                    <span class="string">"Cannot import bean definitions from location ["</span> + location + <span class="string">"]: no ResourceLoader available"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (resourceLoader <span class="keyword">instanceof</span> ResourcePatternResolver) &#123;</span><br><span class="line">            <span class="comment">// Resource pattern matching available.</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Resource[] resources = ((ResourcePatternResolver) resourceLoader).getResources(location);</span><br><span class="line">                <span class="built_in">int</span> loadCount = loadBeanDefinitions(resources);</span><br><span class="line">                <span class="keyword">if</span> (actualResources != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (Resource resource : resources) &#123;</span><br><span class="line">                        actualResources.<span class="built_in">add</span>(resource);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                    logger.debug(<span class="string">"Loaded "</span> + loadCount + <span class="string">" bean definitions from location pattern ["</span> + location + <span class="string">"]"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> loadCount;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(</span><br><span class="line">                        <span class="string">"Could not resolve bean definition resource pattern ["</span> + location + <span class="string">"]"</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Can only load single resources by absolute URL.</span></span><br><span class="line">            Resource resource = resourceLoader.getResource(location);</span><br><span class="line">            <span class="built_in">int</span> loadCount = loadBeanDefinitions(resource);</span><br><span class="line">            <span class="keyword">if</span> (actualResources != <span class="keyword">null</span>) &#123;</span><br><span class="line">                actualResources.<span class="built_in">add</span>(resource);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(<span class="string">"Loaded "</span> + loadCount + <span class="string">" bean definitions from location ["</span> + location + <span class="string">"]"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> loadCount;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>首先getResourceLoader()的实现的前提条件是因为XmlBeanDefinitionReader在实例化的时候已经确定了创建了实例ResourceLoader实例, 代码位于 AbstractBeanDefinitionReader</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> AbstractBeanDefinitionReader(BeanDefinitionRegistry registry) &#123;   </span><br><span class="line">     Assert.notNull(registry, <span class="string">"BeanDefinitionRegistry must not be null"</span>); </span><br><span class="line">     <span class="keyword">this</span>.registry = registry;   </span><br><span class="line">     <span class="comment">// Determine ResourceLoader to use.  </span></span><br><span class="line">     <span class="keyword">if</span> (<span class="keyword">this</span>.registry instanceof ResourceLoader) &#123;     </span><br><span class="line">         <span class="keyword">this</span>.resourceLoader = (ResourceLoader) <span class="keyword">this</span>.registry;   </span><br><span class="line">      &#125;  <span class="keyword">else</span> &#123;      </span><br><span class="line">         <span class="keyword">this</span>.resourceLoader = new PathMatchingResourcePatternResolver();  </span><br><span class="line">      &#125;   </span><br><span class="line">     <span class="comment">// Inherit Environment if possible   </span></span><br><span class="line">     <span class="keyword">if</span> (<span class="keyword">this</span>.registry instanceof EnvironmentCapable) &#123;      </span><br><span class="line">          <span class="keyword">this</span>.environment = ((EnvironmentCapable)<span class="keyword">this</span>.registry).getEnvironment();  </span><br><span class="line">      &#125;  <span class="keyword">else</span> &#123;      </span><br><span class="line">          <span class="keyword">this</span>.environment = new StandardEnvironment(); </span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法比较长，BeanDefinitionReader不能直接加载配置文件，需要把配置文件封装成Resource，然后才能调用重载方法loadBeanDefinitions()。所以这个方法其实就是2段，第一部分是委托ResourceLoader将配置文件封装成Resource，第二部分是调用loadBeanDefinitions()，对Resource进行解析</p>
<p>而这里的ResourceLoader，就是前面的XmlWebApplicationContext，因为ApplicationContext接口，是继承自ResourceLoader接口的</p>
<p>Resource也是一个接口体系，在web环境下，这里就是ServletContextResource</p>
<p>接下来进入重载方法loadBeanDefinitions()</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public int loadBeanDefinitions(Resource<span class="built_in">..</span>. resources) throws BeanDefinitionStoreException &#123;</span><br><span class="line">        Assert.notNull(resources, <span class="string">"Resource array must not be null"</span>);</span><br><span class="line">        int counter = 0;</span><br><span class="line">        <span class="keyword">for</span> (Resource<span class="built_in"> resource </span>: resources) &#123;</span><br><span class="line">            counter += loadBeanDefinitions(resource);</span><br><span class="line">        &#125;</span><br><span class="line">        return counter;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这里就不用说了，就是把每一个Resource作为参数，继续调用重载方法。读spring源码，会发现重载方法特别多。</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">int</span> loadBeanDefinitions(Resource resource)  <span class="keyword">throws</span></span><br><span class="line"> BeanDefinitionStoreException &#123;</span><br><span class="line">        <span class="keyword">return</span> loadBeanDefinitions(<span class="keyword">new</span> EncodedResource(resource));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>还是重载方法，不过这里对传进来的Resource又进行了一次封装，变成了编码后的Resource。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">loadBeanDefinitions</span>(<span class="params">EncodedResource encodedResource</span>) </span></span><br><span class="line"><span class="function">throws BeanDefinitionStoreException </span>&#123;</span><br><span class="line">        Assert.notNull(encodedResource, <span class="string">"EncodedResource must not be null"</span>);</span><br><span class="line">        <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">            logger.info(<span class="string">"Loading XML bean definitions from "</span> + encodedResource.getResource());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Set&lt;EncodedResource&gt; currentResources = <span class="keyword">this</span>.resourcesCurrentlyBeingLoaded.<span class="keyword">get</span>();</span><br><span class="line">        <span class="keyword">if</span> (currentResources == <span class="literal">null</span>) &#123;</span><br><span class="line">            currentResources = <span class="keyword">new</span> HashSet&lt;EncodedResource&gt;(<span class="number">4</span>);</span><br><span class="line">            <span class="keyword">this</span>.resourcesCurrentlyBeingLoaded.<span class="keyword">set</span>(currentResources);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!currentResources.<span class="keyword">add</span>(encodedResource)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(</span><br><span class="line">                    <span class="string">"Detected cyclic loading of "</span> + encodedResource + <span class="string">" - check your import definitions!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            InputStream inputStream = encodedResource.getResource().getInputStream();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                InputSource inputSource = <span class="keyword">new</span> InputSource(inputStream);</span><br><span class="line">                <span class="keyword">if</span> (encodedResource.getEncoding() != <span class="literal">null</span>) &#123;</span><br><span class="line">                    inputSource.setEncoding(encodedResource.getEncoding());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> doLoadBeanDefinitions(inputSource, encodedResource.getResource());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">finally</span> &#123;</span><br><span class="line">                inputStream.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(</span><br><span class="line">                    <span class="string">"IOException parsing XML document from "</span> + encodedResource.getResource(), ex);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span> &#123;</span><br><span class="line">            currentResources.<span class="keyword">remove</span>(encodedResource);</span><br><span class="line">            <span class="keyword">if</span> (currentResources.isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">this</span>.resourcesCurrentlyBeingLoaded.<span class="keyword">remove</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这个就是loadBeanDefinitions()的最后一个重载方法，比较长，可以拆看来看。</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Assert.notNull(encodedResource, <span class="string">"EncodedResource must not be null"</span>);</span><br><span class="line">        <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">            logger.info(<span class="string">"Loading XML bean definitions from "</span> + encodedResource.getResource());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Set&lt;EncodedResource&gt; currentResources = <span class="built_in">this</span>.resourcesCurrentlyBeingLoaded.<span class="keyword">get</span>();</span><br><span class="line">        <span class="keyword">if</span> (currentResources == <span class="literal">null</span>) &#123;</span><br><span class="line">            currentResources = <span class="keyword">new</span> <span class="type">HashSet</span>&lt;EncodedResource&gt;(<span class="number">4</span>);</span><br><span class="line">            <span class="built_in">this</span>.resourcesCurrentlyBeingLoaded.<span class="keyword">set</span>(currentResources);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!currentResources.add(encodedResource)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">BeanDefinitionStoreException</span>(</span><br><span class="line">                    <span class="string">"Detected cyclic loading of "</span> + encodedResource + <span class="string">" - check your import definitions!"</span>);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>这第一部分，是处理线程相关的工作，把当前正在解析的Resource，设置为当前Resource。</p>
<figure class="highlight pony"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">InputStream</span> inputStream = encodedResource.getResource().getInputStream();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">InputSource</span> inputSource = <span class="function"><span class="keyword">new</span> <span class="title">InputSource</span>(inputStream);</span></span><br><span class="line"><span class="function">                <span class="title">if</span> (encodedResource.getEncoding() != <span class="title">null</span>) &#123;</span></span><br><span class="line"><span class="function">                    <span class="title">inputSource</span>.<span class="title">setEncoding</span>(encodedResource.getEncoding());</span></span><br><span class="line"><span class="function">                &#125;</span></span><br><span class="line"><span class="function">                <span class="title">return</span> <span class="title">doLoadBeanDefinitions</span>(inputSource, encodedResource.getResource());</span></span><br><span class="line"><span class="function">            &#125;</span></span><br><span class="line"><span class="function">            <span class="title">finally</span> &#123;</span></span><br><span class="line"><span class="function">                <span class="title">inputStream</span>.<span class="title">close</span>();</span></span><br><span class="line"><span class="function">            &#125;</span></span><br><span class="line"><span class="function">        &#125;</span></span><br></pre></td></tr></table></figure>
<p>这里是第二部分，是核心，首先把Resource还原为InputStream，然后调用实际解析的方法doLoadBeanDefinitions()。<strong>可以看到，这种命名方式是很值得学习的，一种业务方法，比如parse()，可能需要做一些外围的工作，然后实际解析的方法，可以命名为doParse()。这种doXXX()的命名方法，在很多开源框架中都有应用，比如logback等。</strong><br>接下来就看一下这个doLoadBeanDefinitions()方法</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">protected int doLoadBeanDefinitions(InputSource inputSource,<span class="built_in"> Resource </span>resource)</span><br><span class="line">            throws BeanDefinitionStoreException &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Document doc = doLoadDocument(inputSource, resource);return registerBeanDefinitions(doc, resource);</span><br><span class="line">            return registerBeanDefinitions(doc, resource);</span><br><span class="line">        &#125;</span><br><span class="line">        catch (BeanDefinitionStoreException ex) &#123;</span><br><span class="line">            throw ex;</span><br><span class="line">        &#125;</span><br><span class="line">        catch (SAXParseException ex) &#123;</span><br><span class="line">            throw new XmlBeanDefinitionStoreException(resource.getDescription(),</span><br><span class="line">                    <span class="string">"Line "</span> + ex.getLineNumber() + <span class="string">" in XML document from "</span> +<span class="built_in"> resource </span>+ <span class="string">" is invalid"</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">        catch (SAXException ex) &#123;</span><br><span class="line">            throw new XmlBeanDefinitionStoreException(resource.getDescription(),</span><br><span class="line">                    <span class="string">"XML document from "</span> +<span class="built_in"> resource </span>+ <span class="string">" is invalid"</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">        catch (ParserConfigurationException ex) &#123;</span><br><span class="line">            throw new BeanDefinitionStoreException(resource.getDescription(),</span><br><span class="line">                    <span class="string">"Parser configuration exception parsing XML from "</span> + resource, ex);</span><br><span class="line">        &#125;</span><br><span class="line">        catch (IOException ex) &#123;</span><br><span class="line">            throw new BeanDefinitionStoreException(resource.getDescription(),</span><br><span class="line">                    <span class="string">"IOException parsing XML document from "</span> + resource, ex);</span><br><span class="line">        &#125;</span><br><span class="line">        catch (Throwable ex) &#123;</span><br><span class="line">            throw new BeanDefinitionStoreException(resource.getDescription(),</span><br><span class="line">                    <span class="string">"Unexpected exception parsing XML document from "</span> + resource, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>抛开异常处理：核心代码如下：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Document doc = doLoadDocument(<span class="name">inputSource</span>, resource)<span class="comment">;</span></span><br><span class="line">return  registerBeanDefinitions(<span class="name">doc</span>, resource)<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>doLoadDocument方法将InputStream读取成标准的Document对象，然后调用registerBeanDefinitions()，进行解析工作。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">protected Document doLoadDocument(InputSource inputSource,<span class="built_in"> Resource </span>resource) throws Exception &#123;   </span><br><span class="line">    return this.documentLoader.loadDocument(inputSource,  </span><br><span class="line">                                            getEntityResolver(), this.errorHandler,  </span><br><span class="line">                                            getValidationModeForResource(resource),  </span><br><span class="line">                                            isNamespaceAware());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来就看一下这个核心方法registerBeanDefinitions</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">int</span> <span class="title">registerBeanDefinitions</span><span class="params">(Document doc, Resource resource)</span> <span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</span><br><span class="line">        <span class="comment">//创建的其实是DefaultBeanDefinitionDocumentReader 的实例，利用反射创建的。</span></span><br><span class="line">        BeanDefinitionDocumentReader documentReader = createBeanDefinitionDocumentReader();</span><br><span class="line">        documentReader.setEnvironment(<span class="keyword">this</span>.getEnvironment());</span><br><span class="line">        <span class="keyword">int</span> countBefore = getRegistry().getBeanDefinitionCount();</span><br><span class="line">        documentReader.registerBeanDefinitions(doc, createReaderContext(resource));</span><br><span class="line">        <span class="keyword">return</span> getRegistry().getBeanDefinitionCount() - countBefore;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>这里注意两点 :</strong></p>
<blockquote>
<p><strong>1.Document对象</strong><br>首先这个Document对象，是W3C定义的标准XML对象，跟spring无关。其次这个registerBeanDefinitions方法，我觉得命名有点误导性。因为这个时候实际上解析还没有开始，怎么直接就注册了呢。比较好的命名，我觉得可以是parseAndRegisterBeanDefinitions()。<br><strong>2.documentReader的创建时使用反射创建的，代码如下</strong></p>
</blockquote>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> BeanDefinitionDocumentReader    </span><br><span class="line"> createBeanDefinitionDocumentReader() &#123;   </span><br><span class="line">          <span class="keyword">return</span> BeanDefinitionDocumentReader.<span class="keyword">class</span>.cast(BeanUtils.</span><br><span class="line">            instantiateClass(<span class="keyword">this</span>.documentReaderClass));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>instantiateClass方法中传入了一个Class类型的参数。追溯发现下述代码：</p>
<figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">Class</span>&lt;?&gt; documentReaderClass = </span><br><span class="line">DefaultBeanDefinitionDocumentReader.<span class="keyword">class</span>;</span><br></pre></td></tr></table></figure>
<p>所以创建的documentReaderClass是DefaultBeanDefinitionDocumentReader类的实例。<br>接下来就进入BeanDefinitionDocumentReader 中定义的registerBeanDefinitions()方法看看</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(Document doc, XmlReaderContext readerContext)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.readerContext = readerContext;</span><br><span class="line">        logger.debug(<span class="string">"Loading bean definitions"</span>);</span><br><span class="line">        Element root = doc.getDocumentElement();</span><br><span class="line">        doRegisterBeanDefinitions(root);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>处理完外围事务之后，进入doRegisterBeanDefinitions()方法，这种命名规范，上文已经介绍过了</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> void doRegisterBeanDefinitions(Element root) &#123;</span><br><span class="line">        String profileSpec = root.getAttribute(PROFILE_ATTRIBUTE);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(profileSpec)) &#123;</span><br><span class="line">            Assert.state(<span class="keyword">this</span>.environment != <span class="literal">null</span>, <span class="string">"environment property must not be null"</span>);</span><br><span class="line">            String[] specifiedProfiles = StringUtils.tokenizeToStringArray(profileSpec, BeanDefinitionParserDelegate.MULTI_VALUE_ATTRIBUTE_DELIMITERS);</span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">this</span>.environment.acceptsProfiles(specifiedProfiles)) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// any nested &lt;beans&gt; elements will cause recursion in this method. In</span></span><br><span class="line">        <span class="comment">// order to propagate and preserve &lt;beans&gt; default-* attributes correctly,</span></span><br><span class="line">        <span class="comment">// keep track of the current (parent) delegate, which may be null. Create</span></span><br><span class="line">        <span class="comment">// the new (child) delegate with a reference to the parent for fallback purposes,</span></span><br><span class="line">        <span class="comment">// then ultimately reset this.delegate back to its original (parent) reference.</span></span><br><span class="line">        <span class="comment">// this behavior emulates a stack of delegates without actually necessitating one.</span></span><br><span class="line">        BeanDefinitionParserDelegate parent = <span class="keyword">this</span>.delegate;</span><br><span class="line">        <span class="keyword">this</span>.delegate = createHelper(readerContext, root, parent);</span><br><span class="line">        preProcessXml(root);</span><br><span class="line">        parseBeanDefinitions(root, <span class="keyword">this</span>.delegate);</span><br><span class="line">        postProcessXml(root);</span><br><span class="line">        <span class="keyword">this</span>.delegate = parent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法也比较长，拆开来看</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">String profileSpec = root.getAttribute(PROFILE_ATTRIBUTE);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(profileSpec)) &#123;</span><br><span class="line">            Assert.state(<span class="keyword">this</span>.environment != <span class="literal">null</span>, <span class="string">"environment property must not be null"</span>);</span><br><span class="line">            String[] specifiedProfiles = StringUtils.tokenizeToStringArray(profileSpec, BeanDefinitionParserDelegate.MULTI_VALUE_ATTRIBUTE_DELIMITERS);</span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">this</span>.environment.acceptsProfiles(specifiedProfiles)) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果配置文件中元素，配有profile属性，就会进入这一段，不过一般都是不会的</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">BeanDefinitionParserDelegate parent = <span class="keyword">this</span>.<span class="keyword">delegate</span>;</span><br><span class="line"><span class="keyword">this</span>.<span class="keyword">delegate</span> = createHelper(readerContext, root, parent);</span><br><span class="line">preProcessXml(root);</span><br><span class="line">parseBeanDefinitions(root, <span class="keyword">this</span>.<span class="keyword">delegate</span>);</span><br><span class="line">postProcessXml(root);</span><br><span class="line"><span class="keyword">this</span>.<span class="keyword">delegate</span> = parent;</span><br></pre></td></tr></table></figure>
<p>然后这里创建了BeanDefinitionParserDelegate对象，preProcessXml()和postProcessXml()都是空方法，核心就是parseBeanDefinitions()方法。这里又把BeanDefinition解析和注册的工作，委托给了BeanDefinitionParserDelegate对象，在parseBeanDefinitions()方法中完成<br>总的来说，解析工作的委托链是这样的：ClassPathXmlApplicationContext，XmlBeanDefinitionReader，DefaultBeanDefinitionDocumentReader，BeanDefinitionParserDelegate<br>ClassPathXmlApplicationContext作为最外围的组件，发起解析的请求<br>XmlBeanDefinitionReader将配置文件路径封装为Resource，读取出w3c定义的Document对象，然后委托给DefaultBeanDefinitionDocumentReader<br>DefaultBeanDefinitionDocumentReader就开始做实际的解析工作了，但是涉及到bean的具体解析，它还是会继续委托给BeanDefinitionParserDelegate来做。<br>接下来在parseBeanDefinitions()方法中发生了什么，以及BeanDefinitionParserDelegate类完成的工作，在下一篇博客中继续介绍。</p>
<h1 id="loadBeanDefinitions-1"><a href="#loadBeanDefinitions-1" class="headerlink" title="loadBeanDefinitions"></a>loadBeanDefinitions</h1><blockquote>
<p>BeanDefinition的解析,已经走到了DefaultBeanDefinitionDocumentR<br>eader里，这时候配置文件已经被加载，并解析成w3c的Document对象。这篇博客就接着介绍，DefaultBeanDefinitionDocumentReader和BeanDefinitionParserDelegate类，是怎么协同完成bean的解析和注册的。</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">BeanDefinitionParserDelegate parent = <span class="keyword">this</span>.<span class="keyword">delegate</span>;</span><br><span class="line"><span class="keyword">this</span>.<span class="keyword">delegate</span> = createHelper(readerContext, root, parent);</span><br><span class="line">preProcessXml(root);</span><br><span class="line">parseBeanDefinitions(root, <span class="keyword">this</span>.<span class="keyword">delegate</span>);</span><br><span class="line">postProcessXml(root);</span><br><span class="line"><span class="keyword">this</span>.<span class="keyword">delegate</span> = parent;</span><br></pre></td></tr></table></figure>
<p>这段代码，创建了一个BeanDefinitionParserDelegate组件，然后就是preProcessXml()、parseBeanDefinitions()、postProcessXml()方法<br>其中preProcessXml()和postProcessXml()默认是空方法，接下来就看下parseBeanDefinitions()方法</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">parseBeanDefinitions</span>(<span class="params">Element root, BeanDefinitionParserDelegate <span class="keyword">delegate</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">delegate</span>.isDefaultNamespace(root)) &#123;</span><br><span class="line">            NodeList nl = root.getChildNodes();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nl.getLength(); i++) &#123;</span><br><span class="line">                Node node = nl.item(i);</span><br><span class="line">                <span class="keyword">if</span> (node instanceof Element) &#123;</span><br><span class="line">                    Element ele = (Element) node;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">delegate</span>.isDefaultNamespace(ele)) &#123;</span><br><span class="line">                        parseDefaultElement(ele, <span class="keyword">delegate</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">delegate</span>.parseCustomElement(ele);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">delegate</span>.parseCustomElement(root);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>从这个方法开始，BeanDefinitionParserDelegate就开始发挥作用了，判断当前解析元素是否属于默认的命名空间，如果是的话，就调用parseDefaultElement()方法，否则调用delegate上parseCustomElement()方法</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">boolean</span> <span class="title">isDefaultNamespace</span><span class="params">(String namespaceUri)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (!StringUtils.hasLength(namespaceUri) || BEANS_NAMESPACE_URI.equals(namespaceUri));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">boolean</span> <span class="title">isDefaultNamespace</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> isDefaultNamespace(getNamespaceURI(node));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>只有<strong><a href="https://link.jianshu.com/?t=http://www.springframework.org/schema/beans" target="_blank" rel="noopener">http://www.springframework.org/schema/beans</a></strong>，会被认为是默认的命名空间。也就是说，beans、bean这些元素，会认为属于默认的命名空间，而像task:scheduled这些，就认为不属于默认命名空间。<br>根节点beans的一个子节点bean，是属于默认命名空间的，所以会进入parseDefaultElement()方法</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseDefaultElement</span>(<span class="params">Element ele, BeanDefinitionParserDelegate <span class="keyword">delegate</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">delegate</span>.nodeNameEquals(ele, IMPORT_ELEMENT)) &#123;</span><br><span class="line">            importBeanDefinitionResource(ele);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">delegate</span>.nodeNameEquals(ele, ALIAS_ELEMENT)) &#123;</span><br><span class="line">            processAliasRegistration(ele);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">delegate</span>.nodeNameEquals(ele, BEAN_ELEMENT)) &#123;</span><br><span class="line">            processBeanDefinition(ele, <span class="keyword">delegate</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">delegate</span>.nodeNameEquals(ele, NESTED_BEANS_ELEMENT)) &#123;</span><br><span class="line">            <span class="comment">// recurse</span></span><br><span class="line">            doRegisterBeanDefinitions(ele);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这里可能会有4种情况，import、alias、bean、beans，分别有一个方法与之对应，这里解析的是bean元素，所以会进入processBeanDefinition()方法</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">processBeanDefinition</span>(<span class="params">Element ele, BeanDefinitionParserDelegate <span class="keyword">delegate</span></span>) </span>&#123;</span><br><span class="line">        BeanDefinitionHolder bdHolder = <span class="keyword">delegate</span>.parseBeanDefinitionElement(ele);</span><br><span class="line">        <span class="keyword">if</span> (bdHolder != <span class="literal">null</span>) &#123;</span><br><span class="line">            bdHolder = <span class="keyword">delegate</span>.decorateBeanDefinitionIfRequired(ele, bdHolder);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// Register the final decorated instance.</span></span><br><span class="line">                BeanDefinitionReaderUtils.registerBeanDefinition(bdHolder, getReaderContext().getRegistry());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (BeanDefinitionStoreException ex) &#123;</span><br><span class="line">                getReaderContext().error(<span class="string">"Failed to register bean definition with name '"</span> +</span><br><span class="line">                        bdHolder.getBeanName() + <span class="string">"'"</span>, ele, ex);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Send registration event.</span></span><br><span class="line">            getReaderContext().fireComponentRegistered(<span class="keyword">new</span> BeanComponentDefinition(bdHolder));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这里主要有3个步骤，先是委托delegate对bean进行解析，然后委托delegate对bean进行装饰，最后由一个工具类来完成BeanDefinition的注册<br>可以看出来，DefaultBeanDefinitionDocumentReader不负责任何具体的bean解析，它面向的是xml Document对象，根据其元素的命名空间和名称，起一个类似路由的作用（不过，命名空间的判断，也是委托给delegate来做的）。所以这个类的命名，是比较贴切的，突出了其面向Document的特性。具体的工作，是由BeanDefinitionParserDelegate来完成的<br>下面就看下parseBeanDefinitionElement()方法</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">public</span> <span class="keyword">BeanDefinitionHolder </span>parseBeanDefinitionElement(Element ele, <span class="keyword">BeanDefinition </span>containingBean) &#123;</span><br><span class="line">        <span class="keyword">String </span>id = ele.getAttribute(ID_ATTRIBUTE)<span class="comment">;</span></span><br><span class="line">        <span class="keyword">String </span>nameAttr = ele.getAttribute(NAME_ATTRIBUTE)<span class="comment">;</span></span><br><span class="line">        List&lt;<span class="keyword">String&gt; </span>aliases = new ArrayList&lt;<span class="keyword">String&gt;();</span></span><br><span class="line"><span class="keyword"> </span>       <span class="meta">if</span> (<span class="keyword">StringUtils.hasLength(nameAttr)) </span>&#123;</span><br><span class="line">            <span class="keyword">String[] </span>nameArr = <span class="keyword">StringUtils.tokenizeToStringArray(nameAttr, </span><span class="keyword">MULTI_VALUE_ATTRIBUTE_DELIMITERS);</span></span><br><span class="line"><span class="keyword"> </span>           aliases.<span class="keyword">addAll(Arrays.asList(nameArr));</span></span><br><span class="line"><span class="keyword"> </span>       &#125;</span><br><span class="line">        <span class="keyword">String </span><span class="keyword">beanName </span>= id<span class="comment">;</span></span><br><span class="line">        <span class="meta">if</span> (!<span class="keyword">StringUtils.hasText(beanName) </span>&amp;&amp; !aliases.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">beanName </span>= aliases.remove(<span class="number">0</span>)<span class="comment">;</span></span><br><span class="line">            <span class="meta">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(<span class="string">"No XML 'id' specified - using '"</span> + <span class="keyword">beanName </span>+</span><br><span class="line">                        <span class="string">"' as bean name and "</span> + aliases + <span class="string">" as aliases"</span>)<span class="comment">;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">if</span> (containingBean == null) &#123;</span><br><span class="line">            checkNameUniqueness(<span class="keyword">beanName, </span>aliases, ele)<span class="comment">;</span></span><br><span class="line">        &#125;</span><br><span class="line">        AbstractBeanDefinition <span class="keyword">beanDefinition </span>= parseBeanDefinitionElement(ele, <span class="keyword">beanName, </span>containingBean)<span class="comment">;</span></span><br><span class="line">        <span class="meta">if</span> (<span class="keyword">beanDefinition </span>!= null) &#123;</span><br><span class="line">            <span class="meta">if</span> (!<span class="keyword">StringUtils.hasText(beanName)) </span>&#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    <span class="meta">if</span> (containingBean != null) &#123;</span><br><span class="line">                        <span class="keyword">beanName </span>= <span class="keyword">BeanDefinitionReaderUtils.generateBeanName(</span></span><br><span class="line"><span class="keyword"> </span>                               <span class="keyword">beanDefinition, </span>this.readerContext.getRegistry(), true)<span class="comment">;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="meta">else</span> &#123;</span><br><span class="line">                        <span class="keyword">beanName </span>= this.readerContext.generateBeanName(<span class="keyword">beanDefinition);</span></span><br><span class="line"><span class="keyword"> </span>                       // Register an <span class="meta">alias</span> for the plain <span class="keyword">bean </span>class name, <span class="meta">if</span> still possible,</span><br><span class="line">                        // <span class="meta">if</span> the generator returned the class name plus a suffix.</span><br><span class="line">                        // This is expected for Spring <span class="number">1</span>.<span class="number">2</span>/<span class="number">2</span>.<span class="number">0</span> <span class="keyword">backwards </span>compatibility.</span><br><span class="line">                        <span class="keyword">String </span><span class="keyword">beanClassName </span>= <span class="keyword">beanDefinition.getBeanClassName();</span></span><br><span class="line"><span class="keyword"> </span>                       <span class="meta">if</span> (<span class="keyword">beanClassName </span>!= null &amp;&amp;</span><br><span class="line">                                <span class="keyword">beanName.startsWith(beanClassName) </span>&amp;&amp; <span class="keyword">beanName.length() </span>&gt; <span class="keyword">beanClassName.length() </span>&amp;&amp;                      !this.readerContext.getRegistry().<span class="keyword">isBeanNameInUse(beanClassName)) </span>&#123;</span><br><span class="line">                            aliases.<span class="keyword">add(beanClassName);</span></span><br><span class="line"><span class="keyword"> </span>                       &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="meta">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                        logger.debug(<span class="string">"Neither XML 'id' nor 'name' specified - "</span> +</span><br><span class="line">                                <span class="string">"using generated bean name ["</span> + <span class="keyword">beanName </span>+ <span class="string">"]"</span>)<span class="comment">;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                catch (Exception ex) &#123;</span><br><span class="line">                    error(ex.getMessage(), ele)<span class="comment">;</span></span><br><span class="line">                    return null<span class="comment">;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">String[] </span>aliasesArray = <span class="keyword">StringUtils.toStringArray(aliases);</span></span><br><span class="line"><span class="keyword"> </span>           return new <span class="keyword">BeanDefinitionHolder(beanDefinition, </span><span class="keyword">beanName, </span>aliasesArray)<span class="comment">;</span></span><br><span class="line">        &#125;</span><br><span class="line">        return null<span class="comment">;</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这个方法很长，可以分成三段来看</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">String </span>id = ele.getAttribute(ID_ATTRIBUTE)<span class="comment">;</span></span><br><span class="line">        <span class="keyword">String </span>nameAttr = ele.getAttribute(NAME_ATTRIBUTE)<span class="comment">;</span></span><br><span class="line">        List&lt;<span class="keyword">String&gt; </span>aliases = new ArrayList&lt;<span class="keyword">String&gt;();</span></span><br><span class="line"><span class="keyword"> </span>       <span class="meta">if</span> (<span class="keyword">StringUtils.hasLength(nameAttr)) </span>&#123;</span><br><span class="line">            <span class="keyword">String[] </span>nameArr = <span class="keyword">StringUtils.tokenizeToStringArray(nameAttr, </span><span class="keyword">MULTI_VALUE_ATTRIBUTE_DELIMITERS);</span></span><br><span class="line"><span class="keyword"> </span>           aliases.<span class="keyword">addAll(Arrays.asList(nameArr));</span></span><br><span class="line"><span class="keyword"> </span>       &#125;</span><br><span class="line">        <span class="keyword">String </span><span class="keyword">beanName </span>= id<span class="comment">;</span></span><br><span class="line">        <span class="meta">if</span> (!<span class="keyword">StringUtils.hasText(beanName) </span>&amp;&amp; !aliases.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">beanName </span>= aliases.remove(<span class="number">0</span>)<span class="comment">;</span></span><br><span class="line">            <span class="meta">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(<span class="string">"No XML 'id' specified - using '"</span> + <span class="keyword">beanName </span>+</span><br><span class="line">                        <span class="string">"' as bean name and "</span> + aliases + <span class="string">" as aliases"</span>)<span class="comment">;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">if</span> (containingBean == null) &#123;</span><br><span class="line">            checkNameUniqueness(<span class="keyword">beanName, </span>aliases, ele)<span class="comment">;</span></span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>这一段，主要是处理一些跟alias，id等标识相关的东西</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AbstractBeanDefinition <span class="keyword">beanDefinition </span>= parseBeanDefinitionElement(ele, <span class="keyword">beanName, </span>containingBean)<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>这一行是核心，进行实际的解析</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">if</span> (<span class="keyword">beanDefinition </span>!= null) &#123;</span><br><span class="line">            <span class="meta">if</span> (!<span class="keyword">StringUtils.hasText(beanName)) </span>&#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    <span class="meta">if</span> (containingBean != null) &#123;</span><br><span class="line">                        <span class="keyword">beanName </span>= <span class="keyword">BeanDefinitionReaderUtils.generateBeanName(</span></span><br><span class="line"><span class="keyword"> </span>                               <span class="keyword">beanDefinition, </span>this.readerContext.getRegistry(), true)<span class="comment">;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="meta">else</span> &#123;</span><br><span class="line">                        <span class="keyword">beanName </span>= this.readerContext.generateBeanName(<span class="keyword">beanDefinition);</span></span><br><span class="line"><span class="keyword"> </span>                       // Register an <span class="meta">alias</span> for the plain <span class="keyword">bean </span>class name, <span class="meta">if</span> still possible,</span><br><span class="line">                        // <span class="meta">if</span> the generator returned the class name plus a suffix.</span><br><span class="line">                        // This is expected for Spring <span class="number">1</span>.<span class="number">2</span>/<span class="number">2</span>.<span class="number">0</span> <span class="keyword">backwards </span>compatibility.</span><br><span class="line">                        <span class="keyword">String </span><span class="keyword">beanClassName </span>= <span class="keyword">beanDefinition.getBeanClassName();</span></span><br><span class="line"><span class="keyword"> </span>                       <span class="meta">if</span> (<span class="keyword">beanClassName </span>!= null &amp;&amp;</span><br><span class="line">                                <span class="keyword">beanName.startsWith(beanClassName) </span>&amp;&amp; <span class="keyword">beanName.length() </span>&gt; <span class="keyword">beanClassName.length() </span>&amp;&amp;</span><br><span class="line">                                !this.readerContext.getRegistry().<span class="keyword">isBeanNameInUse(beanClassName)) </span>&#123;</span><br><span class="line">                            aliases.<span class="keyword">add(beanClassName);</span></span><br><span class="line"><span class="keyword"> </span>                       &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="meta">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                        logger.debug(<span class="string">"Neither XML 'id' nor 'name' specified - "</span> +</span><br><span class="line">                                <span class="string">"using generated bean name ["</span> + <span class="keyword">beanName </span>+ <span class="string">"]"</span>)<span class="comment">;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                catch (Exception ex) &#123;</span><br><span class="line">                    error(ex.getMessage(), ele)<span class="comment">;</span></span><br><span class="line">                    return null<span class="comment">;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">String[] </span>aliasesArray = <span class="keyword">StringUtils.toStringArray(aliases);</span></span><br><span class="line"><span class="keyword"> </span>           return new <span class="keyword">BeanDefinitionHolder(beanDefinition, </span><span class="keyword">beanName, </span>aliasesArray)<span class="comment">;</span></span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>这段是后置处理，对beanName进行处理<br>前置处理和后置处理，不是核心，就不细看了，重点看下核心的那一行调用</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">public AbstractBeanDefinition parseBeanDefinitionElement(</span><br><span class="line">            Element ele, String <span class="keyword">beanName, </span><span class="keyword">BeanDefinition </span>containingBean) &#123;</span><br><span class="line">        this.parseState.push(new <span class="keyword">BeanEntry(beanName));</span></span><br><span class="line"><span class="keyword"> </span>       String className = null<span class="comment">;</span></span><br><span class="line">        if (ele.hasAttribute(CLASS_ATTRIBUTE)) &#123;</span><br><span class="line">            className = ele.getAttribute(CLASS_ATTRIBUTE).trim()<span class="comment">;</span></span><br><span class="line">        &#125;</span><br><span class="line">        try &#123;</span><br><span class="line">            String parent = null<span class="comment">;</span></span><br><span class="line">            if (ele.hasAttribute(PARENT_ATTRIBUTE)) &#123;</span><br><span class="line">                parent = ele.getAttribute(PARENT_ATTRIBUTE)<span class="comment">;</span></span><br><span class="line">            &#125;</span><br><span class="line">            AbstractBeanDefinition <span class="keyword">bd </span>= createBeanDefinition(className, parent)<span class="comment">;</span></span><br><span class="line">            parseBeanDefinitionAttributes(ele, <span class="keyword">beanName, </span>containingBean, <span class="keyword">bd);</span></span><br><span class="line"><span class="keyword"> </span>           <span class="keyword">bd.setDescription(DomUtils.getChildElementValueByTagName(ele, </span>DESCRIPTION_ELEMENT))<span class="comment">;</span></span><br><span class="line">            parseMetaElements(ele, <span class="keyword">bd);</span></span><br><span class="line"><span class="keyword"> </span>           parseLookupOverrideSubElements(ele, <span class="keyword">bd.getMethodOverrides());</span></span><br><span class="line"><span class="keyword"> </span>           parseReplacedMethodSubElements(ele,   <span class="keyword">bd.getMethodOverrides());</span></span><br><span class="line"><span class="keyword"> </span>           parseConstructorArgElements(ele, <span class="keyword">bd);</span></span><br><span class="line"><span class="keyword"> </span>           parsePropertyElements(ele, <span class="keyword">bd);</span></span><br><span class="line"><span class="keyword"> </span>           parseQualifierElements(ele, <span class="keyword">bd);</span></span><br><span class="line"><span class="keyword"> </span>           <span class="keyword">bd.setResource(this.readerContext.getResource());</span></span><br><span class="line"><span class="keyword"> </span>           <span class="keyword">bd.setSource(extractSource(ele));</span></span><br><span class="line"><span class="keyword"> </span>           return <span class="keyword">bd;</span></span><br><span class="line"><span class="keyword"> </span>       &#125;</span><br><span class="line">        catch (ClassNotFoundException ex) &#123;</span><br><span class="line">            error(<span class="string">"Bean class ["</span> + className + <span class="string">"] not found"</span>, ele, ex)<span class="comment">;</span></span><br><span class="line">        &#125;</span><br><span class="line">        catch (NoClassDefFoundError err) &#123;</span><br><span class="line">            error(<span class="string">"Class that bean class ["</span> + className + <span class="string">"] depends on not found"</span>, ele, err)<span class="comment">;</span></span><br><span class="line">        &#125;</span><br><span class="line">        catch (Throwable ex) &#123;</span><br><span class="line">            error(<span class="string">"Unexpected failure during bean definition parsing"</span>, ele, ex)<span class="comment">;</span></span><br><span class="line">        &#125;</span><br><span class="line">        finally &#123;</span><br><span class="line">            this.parseState.pop()<span class="comment">;</span></span><br><span class="line">        &#125;</span><br><span class="line">        return null<span class="comment">;</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这个方法也挺长的，拆开看看</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.parseState.push(<span class="keyword">new</span> <span class="type">BeanEntry</span>(beanName));</span><br><span class="line">        <span class="keyword">String</span> className = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (ele.hasAttribute(CLASS_ATTRIBUTE)) &#123;</span><br><span class="line">            className = ele.getAttribute(CLASS_ATTRIBUTE).trim();</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>这段是从配置中抽取出类名。接下来的长长一段，把异常处理先抛开，看看实际的业务</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">String parent = null<span class="comment">;</span></span><br><span class="line">if (ele.hasAttribute(PARENT_ATTRIBUTE)) &#123;</span><br><span class="line">    parent = ele.getAttribute(PARENT_ATTRIBUTE)<span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line">AbstractBeanDefinition <span class="keyword">bd </span>= createBeanDefinition(className, parent)<span class="comment">;</span></span><br><span class="line">parseBeanDefinitionAttributes(ele, <span class="keyword">beanName, </span>containingBean, <span class="keyword">bd); </span>                 </span><br><span class="line"><span class="keyword">bd.setDescription(DomUtils.getChildElementValueByTagName(ele, </span>DESCRIPTION_ELEMENT))<span class="comment">;</span></span><br><span class="line">parseMetaElements(ele, <span class="keyword">bd);</span></span><br><span class="line"><span class="keyword">parseLookupOverrideSubElements(ele, </span><span class="keyword">bd.getMethodOverrides());</span></span><br><span class="line"><span class="keyword">parseReplacedMethodSubElements(ele, </span><span class="keyword">bd.getMethodOverrides());</span></span><br><span class="line"><span class="keyword">parseConstructorArgElements(ele, </span><span class="keyword">bd);</span></span><br><span class="line"><span class="keyword">parsePropertyElements(ele, </span><span class="keyword">bd);</span></span><br><span class="line"><span class="keyword">parseQualifierElements(ele, </span><span class="keyword">bd);</span></span><br><span class="line"><span class="keyword">bd.setResource(this.readerContext.getResource());</span></span><br><span class="line"><span class="keyword">bd.setSource(extractSource(ele));</span></span><br><span class="line"><span class="keyword">return </span><span class="keyword">bd;</span></span><br></pre></td></tr></table></figure>
<p>这里每个方法的命名，就说明了是要干什么，可以一个个跟进去看，本文就不细说了。总之，经过这里的解析，就得到了一个完整的BeanDefinitionHolder。只是说明一下，如果在配置文件里，没有对一些属性进行设置，比如autowire-candidate等，那么这个解析生成的BeanDefinition，都会得到一个默认值<br><strong>然后，对这个Bean做一些必要的装饰</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> BeanDefinitionHolder <span class="title">decorateBeanDefinitionIfRequired</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            Element ele, BeanDefinitionHolder definitionHolder, BeanDefinition containingBd)</span> </span>&#123;</span><br><span class="line">        BeanDefinitionHolder finalDefinition = definitionHolder;</span><br><span class="line">        <span class="comment">// Decorate based on custom attributes first.</span></span><br><span class="line">        NamedNodeMap attributes = ele.getAttributes();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; attributes.getLength(); i++) &#123;</span><br><span class="line">            Node node = attributes.item(i);</span><br><span class="line">            finalDefinition = decorateIfRequired(node, finalDefinition, containingBd);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Decorate based on custom nested elements.</span></span><br><span class="line">        NodeList children = ele.getChildNodes();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; children.getLength(); i++) &#123;</span><br><span class="line">            Node node = children.item(i);</span><br><span class="line">            <span class="keyword">if</span> (node.getNodeType() == Node.ELEMENT_NODE) &#123;</span><br><span class="line">                finalDefinition = decorateIfRequired(node, finalDefinition, containingBd);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> finalDefinition;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>持续单步调试，代码继续运行到DefaultBeanDefinitionDocumentReader中的processBeanDefinition中的registerBeanDefinition()</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">BeanDefinitionReaderUtils</span><span class="selector-class">.registerBeanDefinition</span>(<span class="selector-tag">bdHolder</span>, </span><br><span class="line"><span class="selector-tag">getReaderContext</span>()<span class="selector-class">.getRegistry</span>());</span><br></pre></td></tr></table></figure>
<p>单步进入代码发现BeanDefinitionReaderUtils静态方法registerBeanDefinition()</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">public</span> static void registerBeanDefinition(</span><br><span class="line">            <span class="keyword">BeanDefinitionHolder </span>definitionHolder, <span class="keyword">BeanDefinitionRegistry </span>registry)</span><br><span class="line">            throws <span class="keyword">BeanDefinitionStoreException </span>&#123;</span><br><span class="line">        // Register <span class="keyword">bean </span>definition under primary name.</span><br><span class="line">        <span class="keyword">String </span><span class="keyword">beanName </span>= definitionHolder.getBeanName()<span class="comment">;</span></span><br><span class="line">        // 其实调用的是DefaultListableBeanFactory中的registerBeanDefinition方法</span><br><span class="line">        registry.registerBeanDefinition(<span class="keyword">beanName, </span>definitionHolder.getBeanDefinition())<span class="comment">;</span></span><br><span class="line">        // Register aliases for <span class="keyword">bean </span>name, <span class="meta">if</span> any.</span><br><span class="line">        <span class="keyword">String[] </span>aliases = definitionHolder.getAliases()<span class="comment">;</span></span><br><span class="line">        <span class="meta">if</span> (aliases != null) &#123;</span><br><span class="line">            for (<span class="keyword">String </span>aliase : aliases) &#123;</span><br><span class="line">                registry.registerAlias(<span class="keyword">beanName, </span>aliase)<span class="comment">;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>解释一下<strong>其实调用的是DefaultListableBeanFactory中的registerBeanDefinition方法</strong>这句话，因为DefaultListableBeanFactory实现BeanDefinitionRegistry接口，BeanDefinitionRegistry接口中定义了registerBeanDefinition()方法<br>看下DefaultListableBeanFactory中registerBeanDefinition()实例方法的具体实现：</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">public</span> void registerBeanDefinition(<span class="keyword">String </span><span class="keyword">beanName, </span><span class="keyword">BeanDefinition </span><span class="keyword">beanDefinition)</span></span><br><span class="line"><span class="keyword"> </span>           throws <span class="keyword">BeanDefinitionStoreException </span>&#123;</span><br><span class="line">        <span class="meta">Assert</span>.hasText(<span class="keyword">beanName, </span><span class="string">"Bean name must not be empty"</span>)<span class="comment">;</span></span><br><span class="line">        <span class="meta">Assert</span>.notNull(<span class="keyword">beanDefinition, </span><span class="string">"BeanDefinition must not be null"</span>)<span class="comment">;</span></span><br><span class="line">        <span class="meta">if</span> (<span class="keyword">beanDefinition </span>instanceof AbstractBeanDefinition) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                ((AbstractBeanDefinition) <span class="keyword">beanDefinition).validate();</span></span><br><span class="line"><span class="keyword"> </span>           &#125;</span><br><span class="line">            catch (<span class="keyword">BeanDefinitionValidationException </span>ex) &#123;</span><br><span class="line">                throw new <span class="keyword">BeanDefinitionStoreException(beanDefinition.getResourceDescription(), </span><span class="keyword">beanName,</span></span><br><span class="line"><span class="keyword"> </span>                       <span class="string">"Validation of bean definition failed"</span>, ex)<span class="comment">;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        synchronized (this.<span class="keyword">beanDefinitionMap) </span>&#123;</span><br><span class="line">            Object oldBeanDefinition = this.<span class="keyword">beanDefinitionMap.get(beanName);</span></span><br><span class="line"><span class="keyword"> </span>           <span class="meta">if</span> (oldBeanDefinition != null) &#123;</span><br><span class="line">                <span class="meta">if</span> (!this.allowBeanDefinitionOverriding) &#123;</span><br><span class="line">                    throw new <span class="keyword">BeanDefinitionStoreException(beanDefinition.getResourceDescription(), </span><span class="keyword">beanName,</span></span><br><span class="line"><span class="keyword"> </span>                           <span class="string">"Cannot register bean definition ["</span> + <span class="keyword">beanDefinition </span>+ <span class="string">"] for bean '"</span> + <span class="keyword">beanName </span>+</span><br><span class="line">                            <span class="string">"': There is already ["</span> + oldBeanDefinition + <span class="string">"] bound."</span>)<span class="comment">;</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="meta">else</span> &#123;</span><br><span class="line">                    <span class="meta">if</span> (this.logger.isInfoEnabled()) &#123;</span><br><span class="line">                        this.logger.info(<span class="string">"Overriding bean definition for bean '"</span> + <span class="keyword">beanName </span>+</span><br><span class="line">                                <span class="string">"': replacing ["</span> + oldBeanDefinition + <span class="string">"] with ["</span> + <span class="keyword">beanDefinition </span>+ <span class="string">"]"</span>)<span class="comment">;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">else</span> &#123;</span><br><span class="line">                this.<span class="keyword">beanDefinitionNames.add(beanName);</span></span><br><span class="line"><span class="keyword"> </span>               this.frozenBeanDefinitionNames = null<span class="comment">;</span></span><br><span class="line">            &#125;</span><br><span class="line">            this.<span class="keyword">beanDefinitionMap.put(beanName, </span><span class="keyword">beanDefinition);</span></span><br><span class="line"><span class="keyword"> </span>           resetBeanDefinition(<span class="keyword">beanName);</span></span><br><span class="line"><span class="keyword"> </span>       &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>代码追溯之后发现这个方法里，最关键的是以下2行：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">this</span><span class="selector-class">.beanDefinitionNames</span><span class="selector-class">.add</span>(<span class="selector-tag">beanName</span>);</span><br><span class="line"><span class="selector-tag">this</span><span class="selector-class">.beanDefinitionMap</span><span class="selector-class">.put</span>(<span class="selector-tag">beanName</span>, <span class="selector-tag">beanDefinition</span>);</span><br></pre></td></tr></table></figure>
<p>前者是把beanName放到队列里，后者是把BeanDefinition放到map中，到此注册就完成了。在后面实例化的时候，就是把beanDefinitionMap中的BeanDefinition取出来，逐一实例化<br>BeanFactory准备完毕之后，代码又回到了ClassPathXmlApplicationContext里</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>.startupShutdownMonitor) &#123;</span><br><span class="line">            <span class="comment">// Prepare this context for refreshing.</span></span><br><span class="line">            prepareRefresh();</span><br><span class="line">            <span class="comment">// Tell the subclass to refresh the internal bean factory.</span></span><br><span class="line">            ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();</span><br><span class="line">            <span class="comment">// Prepare the bean factory for use in this context.</span></span><br><span class="line">            prepareBeanFactory(beanFactory);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// Allows post-processing of the bean factory in context subclasses.</span></span><br><span class="line">                postProcessBeanFactory(beanFactory);</span><br><span class="line">                <span class="comment">// Invoke factory processors registered as beans in the context.</span></span><br><span class="line">                invokeBeanFactoryPostProcessors(beanFactory);</span><br><span class="line">                <span class="comment">// Register bean processors that intercept bean creation.</span></span><br><span class="line">                registerBeanPostProcessors(beanFactory);</span><br><span class="line">                <span class="comment">// Initialize message source for this context.</span></span><br><span class="line">                initMessageSource();</span><br><span class="line">                <span class="comment">// Initialize event multicaster for this context.</span></span><br><span class="line">                initApplicationEventMulticaster();</span><br><span class="line">                <span class="comment">// Initialize other special beans in specific context subclasses.</span></span><br><span class="line">                onRefresh();</span><br><span class="line">                <span class="comment">// Check for listener beans and register them.</span></span><br><span class="line">                registerListeners();</span><br><span class="line">                <span class="comment">// Instantiate all remaining (non-lazy-init) singletons.</span></span><br><span class="line">                finishBeanFactoryInitialization(beanFactory);</span><br><span class="line">                <span class="comment">// Last step: publish corresponding event.</span></span><br><span class="line">                finishRefresh();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">                <span class="comment">// Destroy already created singletons to avoid dangling resources.</span></span><br><span class="line">                destroyBeans();</span><br><span class="line">                <span class="comment">// Reset 'active' flag.</span></span><br><span class="line">                cancelRefresh(ex);</span><br><span class="line">                <span class="comment">// Propagate exception to caller.</span></span><br><span class="line">                <span class="keyword">throw</span> ex;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>也就是obtainFreshBeanFactory()方法执行之后，再进行下面的步骤。<br>总结来说，ApplicationContext将解析配置文件的工作委托给BeanDefinitionReader，然后BeanDefinitionReader将配置文件读取为xml的Document文档之后，又委托给BeanDefinitionDocumentReader<br>BeanDefinitionDocumentReader这个组件是根据xml元素的命名空间和元素名，起到一个路由的作用，实际的解析工作，是委托给BeanDefinitionParserDelegate来完成的<br>BeanDefinitionParserDelegate的解析工作完成以后，会返回BeanDefinitionHolder给BeanDefinitionDocumentReader，在这里，会委托给DefaultListableBeanFactory完成bean的注册<br>XmlBeanDefinitionReader（计数、解析XML文档），BeanDefinitionDocumentReader（依赖xml文档，进行解析和注册），BeanDefinitionParserDelegate（实际的解析工作）。可以看出，在解析bean的过程中，这3个组件的分工是比较清晰的，各司其职，这种设计思想值得学习<br>到此为止，bean的解析、注册、spring ioc 容器的实例化过程就基本分析结束了。</p>
<p>作者：fxliutao<br>链接：<a href="https://www.jianshu.com/p/963f87a5c4d7" target="_blank" rel="noopener">https://www.jianshu.com/p/963f87a5c4d7</a><br>來源：简书<br>著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p>

      
    </div>
    
    
    

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    h2pl
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://h2pl.github.io/2018/06/02/spring2/" title="Spring源码剖析2：Spring IOC容器的加载过程">http://h2pl.github.io/2018/06/02/spring2/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Spring-IOC/" rel="tag"># Spring IOC</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/06/02/spring1/" rel="next" title="Spring源码剖析1：初探Spring IOC核心流程">
                <i class="fa fa-chevron-left"></i> Spring源码剖析1：初探Spring IOC核心流程
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/06/03/spring3/" rel="prev" title="Spring源码剖析3：懒加载的单例Bean获取过程分析">
                Spring源码剖析3：懒加载的单例Bean获取过程分析 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC8zNTkxMC8xMjQ0Ng=="></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="h2pl" />
            
              <p class="site-author-name" itemprop="name">h2pl</p>
              <p class="site-description motion-element" itemprop="description">Java后端开发之路</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">95</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">9</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">33</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/h2pl" target="_blank" title="Github">
                      
                        <i class="fa fa-fw fa-github"></i>Github</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:362294931@qq.com" target="_blank" title="Email">
                      
                        <i class="fa fa-fw fa-envelope"></i>Email</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.zhihu.com/people/h2pl" target="_blank" title="知乎">
                      
                        <i class="fa fa-fw fa-gratipay"></i>知乎</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://blog.csdn.net/a724888" target="_blank" title="CSDN">
                      
                        <i class="fa fa-fw fa-globe"></i>CSDN</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                友情链接
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.jianshu.com/users/9ab8d7b38c4e" title="我的简书" target="_blank">我的简书</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#spring-ioc-容器的加载流程"><span class="nav-number">1.</span> <span class="nav-text">spring ioc 容器的加载流程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Spring-Ioc-Demo"><span class="nav-number">1.1.</span> <span class="nav-text">Spring Ioc Demo</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ApplicationContext-继承结构"><span class="nav-number">1.2.</span> <span class="nav-text">ApplicationContext 继承结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Spring-Ioc容器加载过程源码详解"><span class="nav-number">1.3.</span> <span class="nav-text">Spring Ioc容器加载过程源码详解</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#refresh-方法"><span class="nav-number">2.</span> <span class="nav-text">refresh()方法</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#调试栈截图"><span class="nav-number">2.1.</span> <span class="nav-text">调试栈截图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#整体流程"><span class="nav-number">2.2.</span> <span class="nav-text">整体流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#bean-xml的处理"><span class="nav-number">2.3.</span> <span class="nav-text">bean.xml的处理</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#loadBeanDefinitions"><span class="nav-number">3.</span> <span class="nav-text">loadBeanDefinitions</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#loadBeanDefinitions-源码阅读"><span class="nav-number">3.1.</span> <span class="nav-text">loadBeanDefinitions: 源码阅读</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#loadBeanDefinitions-1"><span class="nav-number">4.</span> <span class="nav-text">loadBeanDefinitions</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">h2pl

  &nbsp;&nbsp;|&nbsp;&nbsp;
  <script type="text/javascript">
    var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");
    document.write('站长统计'' type='text/javascript'%3E%3C/script%3E"));
  </script>

  &nbsp;&nbsp;|&nbsp;&nbsp;<span><a href="/sitemap.xml">Google网站地图</a></span>
  &nbsp;&nbsp;|&nbsp;&nbsp;<span><a href="/baidusitemap.xml">百度网站地图</a></span>

  </span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


&nbsp;&nbsp;|&nbsp;&nbsp;本站总点击 <span id="busuanzi_value_site_pv"></span> 次
&nbsp;&nbsp;|&nbsp;&nbsp;您是第 <span id="busuanzi_value_site_uv"></span> 位访客

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

<script>
(function(){
    var bp = document.createElement('script');
    bp.src = '//push.zhanzhang.baidu.com/push.js';
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  












  





  

  

  

  
  

  

  

  

    <!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/love.js"></script>

</body>
</html>
